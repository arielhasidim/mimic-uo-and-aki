---
title: "Toward the standardization of big datasets of urine output for AKI analysis: a multicenter validation study"
author: "Ariel Avraham Hasidim, Matthew Adam Klein, Itamar Ben Shitrit, Sharon Einav, Karny Ilan, Lior Fuchs"
date: "February 24th, 2025"
output: 
  html_document:
    code_folding: hide
    toc: yes
    number_sections: no
    toc_float: yes
    toc_collapsed: yes
    toc_depth: 3
    theme: simplex
    code_download: no
params: 
  billing_account: "CHANGE TO BILLING ACCOUNT"
---
<!-- ################################ NOTICE ################################### -->
<!-- # 1. Running and creating the hourly-adjusted UO and AKI tables in the    # -->
<!-- #    associated billing account/project name is a preliminary requirement.# -->
<!-- #    For more information and instruction see the GitHub repository.      # -->
<!-- #                                                                         # -->
<!-- # 2. Please use 'Knit with Parameters' to provide your billing account    # -->
<!-- #    for Google's BigQuery that is credentialed for PhysioNet/MIMIC-IV.   # -->
<!-- ########################################################################### -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

# Installs pacman ("package manager") if needed
if (!require("pacman")) install.packages("pacman")

# Use pacman to load add-on packages as desired
pacman::p_load(pacman, DBI, bigrquery, tidyverse, reshape2, finalfit, psych,
               ggplot2, ggbreak,scales,ggpmisc, ggforce, rlang, quantreg,
               broom, kableExtra, rmdformats, survival, survminer, nortest,
               gtsummary, ggsci, ggsurvfit, gt, rms, marginaleffects)

# Establish connection with BigQuery and billing acount with the correct access
con <- dbConnect(
  bigrquery::bigquery(),
  project = "physionet-data",
  dataset = "mimiciv_icu",
  billing = params$billing_account
)

dbListTables(con)

add_by_n <- function(data, variable, by, ...) {
  data |> 
    select(all_of(c(variable, by))) |> 
    dplyr::arrange(pick(all_of(c(by, variable)))) |> 
    dplyr::group_by(.data[[by]]) |> 
    dplyr::summarise_all(~sum(!is.na(.))) %>%
    rlang::set_names(c("by", "variable")) %>%
    mutate(
      by_col = paste0("add_n_stat_", dplyr::row_number()),
      variable = style_number(variable)
    ) %>%
    select(-by) %>%
    tidyr::pivot_wider(names_from = by_col, 
                       values_from = variable)
}
```

```{r Quering BigQuery, cache=FALSE, include=FALSE}
raw_uo <- dbGetQuery(con, "SELECT * FROM `mimic_uo_and_aki.a_urine_output_raw`")

raw_uo_eligible <- dbGetQuery(con, statement = read_file('sql/raw eligible.sql'))

raw_uo_excluions_duplicates <- dbGetQuery(con, statement = read_file('sql/raw_uo_excluions_duplicates.sql'))

uo_rate_including_null_collection_period <- dbGetQuery(con, "SELECT * FROM `mimic_uo_and_aki.b_uo_rate`")
uo_rate <- uo_rate_including_null_collection_period %>%
  drop_na(TIME_INTERVAL)

hourly_uo <- dbGetQuery(con, "SELECT * FROM `mimic_uo_and_aki.c_hourly_uo`")
uo_ml_kg_hr <- hourly_uo %>% 
  drop_na(HOURLY_WEIGHTED_MEAN_RATE, WEIGHT_ADMIT) %>%
  mutate(ML_KG_HR = HOURLY_WEIGHTED_MEAN_RATE / WEIGHT_ADMIT)

kdigo_uo_stage <-
  dbGetQuery(con,
             "SELECT * FROM `mimic_uo_and_aki.d3_kdigo_stages` WHERE aki_stage_uo_cons IS NOT NULL")

table_1 <- dbGetQuery(con, statement = read_file('sql/tbl1.sql'))

akis_all_wide <- dbGetQuery(con, statement = read_file('sql/akis.sql')) %>%
  filter(FOLLOWUP_DAYS >= 0) %>%
  filter(WEIGHT_ADMIT <= 300,
         WEIGHT_ADMIT >= 25) %>%
  mutate(
    mortality_7 = if_else(DEATH_FLAG == 1 &
                            FOLLOWUP_DAYS < 8, 1, 0),
    mortality_30 = if_else(DEATH_FLAG == 1 &
                             FOLLOWUP_DAYS < 31, 1, 0),
    mortality_90 = if_else(FOLLOWUP_DAYS < 91 &
                                 DEATH_FLAG == 1, 1, 0)
  )

akis_all_long <- akis_all_wide %>%
  select(-FIRST_POSITIVE_STAGE_UO_CONS_TIME, 
         -FIRST_POSITIVE_STAGE_UO_MEAN_TIME,
         -WEIGHT_ADMIT) %>%
  left_join((
    table_1 %>%
      select(STAY_ID, admission_age, gender, charlson_comorbidity_index, apsiii, weight_admit)
  ),
  by = "STAY_ID") %>%
  mutate(
    max_stage.old = MAX_STAGE_OLD,
    max_stage.newcons = MAX_STAGE_NEW_CONS,
    max_stage.newmean = MAX_STAGE_NEW_MEAN,
    first_stage.old = FIRST_STAGE_OLD,
    first_stage.newcons = FIRST_STAGE_NEW_CONS,
    first_stage.newmean = FIRST_STAGE_NEW_MEAN,
    compartments.old = COMPARTMENT_COUNT,
    compartments.newcons = COMPARTMENT_COUNT,
    compartments.newmean = COMPARTMENT_COUNT,
    .keep = "unused"
  ) %>%
  pivot_longer(
    !c(
      STAY_ID,
      HADM_ID,
      SUBJECT_ID,
      admission_age,
      weight_admit,
      gender,
      charlson_comorbidity_index,
      apsiii,
      FOLLOWUP_DAYS,
      DEATH_FLAG,
      mortality_7,
      mortality_30,
      mortality_90
    ),
    names_sep = "\\.",
    names_to = c(".value", "group")
  ) %>%
  mutate(
    prevalnce_admit = if_else(first_stage > 0, 1, 0),
    Incidence_first_72hr = case_when(first_stage > 0 ~ NA, max_stage == 0 ~ 0, max_stage > 0 ~ 1),
    Incidence_first_72hr_with_stage = ifelse(first_stage == 0 &
                                               max_stage > 0, max_stage, NA),
    .keep = "all"
  ) 

creat_diff <- dbGetQuery(con, statement = read_file('sql/creat diff.sql'))

anchor_year <- dbGetQuery(con, statement = read_file('sql/anchor year.sql'))
```
\ 

This is a full reproduction for the results of the derivation cohort (MIMICdb).

\ 

### Citation

.............

.............

------------------------------------------------------------------------

# Population and Study's Sample

**Total ICU stays in mimic:**
```{r}
dbGetQuery(con, "SELECT count(*) FROM `physionet-data.mimiciv_icu.icustays`")
```

\ 

**ICU stays with UO records (eligible):**

```{r}
n_distinct(raw_uo$STAY_ID)
```

\

**Hospital admissions with UO records:**

```{r}
n_distinct(raw_uo$HADM_ID)
```

\ 

**Patients with UO records:**

```{r}
n_distinct(raw_uo$SUBJECT_ID)
```

\ 

**Count all UO records (before exclusions):**

```{r}
all_rows_count <- nrow(raw_uo)
all_rows_count
```

\ 

## Figure for Raw UO Records Data
Frequency of urine output charting by source
```{r}
S3a <- raw_uo %>% 
  mutate(
    LABEL = case_when(
      LABEL == "GU Irrigant/Urine Volume Out" ~ "GU Irrig. Out",
      LABEL == "GU Irrigant Volume In" ~ "GU Irrig. In",
      .default = LABEL
    )
  ) %>% count(LABEL, sort = TRUE) %>%
   ggplot(aes(x=reorder(LABEL, -n), y=n)) +
   geom_bar(stat="identity") +
   xlab("") +
   ylab("") +
   geom_bar(stat="identity", fill="steelblue") +
   geom_text(aes(label=n), vjust=-0.6, color="black", size=3) +
   theme_classic() +
   theme(axis.text.y=element_blank()) +
   theme(axis.text.x = element_text(angle = 45, hjust = 1))

S3a
```

\ 

## Temporal Trends Analysis

The MIMIC-IV dataset is a collection of data collected between 2005 and 2022. Each patient in the dataset has an "anchor year" that is organized into Three-year periods.

**Frequency of urine output charting by year:**

For each hospital admission, we adjust the beginning of the anchor year based on the years elapsed since the patient's first hospital admission. 

```{r}
S4_b <- raw_uo %>%
  left_join(anchor_year, by = "HADM_ID") %>%
  count(ANCHOR_START, sort = TRUE) %>%
   ggplot(aes(x=as_factor(ANCHOR_START), y=n)) +
   geom_bar(stat="identity") +
   xlab("Anchor year starts") +
   ylab("") +
   geom_bar(stat="identity", fill="steelblue") +
   geom_text(aes(label=n), vjust=-0.6, color="black", size=3) +
   theme_classic() +
   theme(axis.text.y=element_blank()) +
   theme(axis.text.x = element_text(angle = 45, hjust = 1))

S4_b
```

**Regrouping:**

```{r}
anchor_year_regrouped <- anchor_year %>%
  mutate(ANCHOR_GROUP = case_when(ANCHOR_START < 2011 ~ "2008-2010",
                                       ANCHOR_START >= 2011 & ANCHOR_START < 2014 ~ "2011-2013",
                                       ANCHOR_START >= 2014 & ANCHOR_START < 2017 ~ "2014-2016",
                                       .default = "2017+"))
```

**Frequency of urine output charting by year:**

```{r}
positions <- c("2008-2010", "2011-2013", "2014-2016", "2017+")

S4_c <- raw_uo %>%
  left_join(anchor_year_regrouped, by = "HADM_ID") %>%
  count(ANCHOR_GROUP, sort = TRUE) %>%
   ggplot(aes(x=as_factor(ANCHOR_GROUP), y=n)) +
   scale_x_discrete(limits = positions) +
   geom_bar(stat="identity") +
   xlab("Grouped anchor years") +
   ylab("") +
   geom_bar(stat="identity", fill="steelblue") +
   geom_text(aes(label=n), vjust=-0.6, color="black", size=3) +
   theme_classic() +
   theme(axis.text.y=element_blank()) +
   theme(axis.text.x = element_text(angle = 45, hjust = 1))

S4_c
```

**Frequency of urine output charting by source:**

```{r}
positions <- c("2008-2010", "2011-2013", "2014-2016", "2017+")

S4_d <- raw_uo %>%
  left_join(anchor_year_regrouped, by = "HADM_ID") %>%
  mutate(
    LABEL = case_when(
      LABEL == "GU Irrigant/Urine Volume Out" ~ "GU Irrig. Out",
      LABEL == "GU Irrigant Volume In" ~ "GU Irrig. In",
      .default = LABEL
    )
  ) %>%
  group_by(ANCHOR_GROUP) %>%
  count(LABEL, sort = TRUE) %>%
  ggplot(aes(
    fill = LABEL,
    y = n,
    x = as_factor(ANCHOR_GROUP)
  )) +
  scale_x_discrete(limits = positions) +
  geom_bar(position = "fill", stat = "identity") +
  xlab("Grouped anchor years") +
  ylab("Proportions") +
  scale_fill_discrete(name = "Source") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

S4_d
```

**Mean urine output volume by source:**

```{r}
S4_e <- uo_rate_including_null_collection_period %>%
  left_join(anchor_year_regrouped, by = "HADM_ID") %>%
  group_by(ANCHOR_GROUP, SOURCE) %>%
  summarise(Mean = mean(VALUE, na.rm = TRUE)) %>%
  ggplot(aes(
    fill = as_factor(ANCHOR_GROUP),
    y = Mean,
    x = SOURCE
  )) +
  geom_bar(position = "dodge", stat = "identity") +
  xlab("Source") +
  ylab("mL") +
  scale_fill_discrete(name = "Grouped anchor years") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

S4_e
```

**Mean collection time by source:**

```{r}
S4_f <- uo_rate %>%
  left_join(anchor_year_regrouped, by = "HADM_ID") %>%
  group_by(ANCHOR_GROUP, SOURCE) %>%
  summarise(Mean = mean(TIME_INTERVAL, na.rm=TRUE)) %>%
  ggplot(aes(fill=as_factor(ANCHOR_GROUP), y=Mean / 60, x=SOURCE)) + 
    geom_bar(position="dodge", stat="identity") +
  xlab("Source") +
  ylab("Hr") +
  scale_fill_discrete(name = "Anchor year starts") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

S4_f
```

\ 

## Check for Duplications

### Distinctiveness

First, we are basing distinctive rows in the raw UO data.

**Count distinct raw rows:**

```{r}
distinct_time_item_patient_rows_count <- raw_uo %>% 
  select(-VALUE, 
         -SERVICE, 
         -LABEL) %>% 
  n_distinct()

distinct_time_item_patient_rows_count
```

Conclusion: the original raw query does not have duplicates (all rows are distinct by all columns)

\ 

### Simultaneous Charting

```{r}
raw_uo_excluions_duplicates$same_value <- as.factor(raw_uo_excluions_duplicates$same_value)
raw_uo_excluions_duplicates$label <- as.factor(raw_uo_excluions_duplicates$label)
raw_uo_excluions_duplicates$label <- factor(raw_uo_excluions_duplicates$label, levels = as.factor(names(sort(table(raw_uo_excluions_duplicates$label),
                                  decreasing = TRUE))))

S4_a <- raw_uo_excluions_duplicates %>%
  select(same_value, label) %>%
  tbl_summary(by = same_value)

S4_a
```

|       Show full SQL query -----\>

```{sql, class.source = 'fold-hide', eval=FALSE, code = readLines("sql/raw_uo_excluions_duplicates.sql")}
```

In conclusion, most of the records have different values, and thus human error in duplicate record-keeping is not likely.

\ 

## Exclusion

**ICU type exclusion:**

```{r}
dbGetQuery(con, statement = read_file('sql/service_type_exclusion.sql'))
```

|       Show full SQL query -----\>

```{sql, class.source = 'fold-hide', eval=FALSE, code = readLines("sql/service_type_exclusion.sql")}
```

\ 

**Uretral stent exclusion:**

```{r}
dbGetQuery(con, statement = read_file('sql/ure_stent_exclusion.sql'))
```

|       Show full SQL query -----\>

```{sql, class.source = 'fold-hide', eval=FALSE, code = readLines("sql/ure_stent_exclusion.sql")}
```

\ 

**GU irrigation exclusion:**

```{r}
dbGetQuery(con, statement = read_file('sql/gu_irig_exclusion.sql'))
```

|       Show full SQL query -----\>

```{sql, class.source = 'fold-hide', eval=FALSE, code = readLines("sql/gu_irig_exclusion.sql")}
```

\ 

**Not passing UO sanity check:**

```{r}
dbGetQuery(con, statement = read_file('sql/sanity.sql'))
```

|       Show full SQL query -----\>

```{sql, class.source = 'fold-hide', eval=FALSE, code = readLines("sql/sanity.sql")}
```

\ 

**Total raw urine output after exclusion ("included records, before dropping records without collection times"):**

```{r}
nrow(raw_uo_eligible)
```

|       Show full SQL query -----\>

```{sql, class.source = 'fold-hide', eval=FALSE, code = readLines("sql/raw eligible.sql")}
```

\ 

**Total icu stays after exclusion ("included records, before dropping records without collection times"):**

```{r}
n_distinct(raw_uo_eligible$STAY_ID)
```

\ 

**Exclusion of first volume in each compartment per ICU stay:**

```{r}
uo_rate_including_null_collection_period %>%
  filter(STAY_ID %in% raw_uo_eligible$STAY_ID) %>%
  filter(is.na(TIME_INTERVAL)) %>%
  nrow()
```

\ 

**UO records with time intervals ("Included records"):**

```{r}
uo_rate_including_null_collection_period %>%
  filter(STAY_ID %in% raw_uo_eligible$STAY_ID) %>%
  drop_na(TIME_INTERVAL) %>%
  nrow()
```

\ 

**Count UO records by anatomical compartment:**

```{r}
uo_rate %>% 
  mutate(agg_group = case_when(SOURCE == "Foley" |
                                 SOURCE == "Condom Cath" |
                                 SOURCE == "Straight Cath" |
                                 SOURCE == "Suprapubic" |
                                 SOURCE == "Void" ~ "Urinary bladder",
                               TRUE ~ SOURCE)
  ) %>%
           group_by(agg_group) %>%
   dplyr::summarise(N = n()
  )
```

\ 

**ICU stays with UO records with time intervals:**

```{r}
print("ICU stays after exclusion criteria:")
uo_rate_including_null_collection_period %>%
  {n_distinct(.$STAY_ID)}

print("Included ICU stays (has time intervals):")
uo_rate_including_null_collection_period %>%
                     drop_na(TIME_INTERVAL) %>%
  {n_distinct(.$STAY_ID)}

print("ICU stays with UO records that does not  have time interval (no previous UO record in the same compartment:")
uo_rate_including_null_collection_period %>%
                     filter(is.na(TIME_INTERVAL)) %>%
  {n_distinct(.$STAY_ID)}

print("ICU stays dropped due to no UO records with time intervalst (no previous UO record in the same compartment:")
(uo_rate_including_null_collection_period %>%
                     filter(is.na(TIME_INTERVAL))) %>%
  filter(!(STAY_ID %in% (uo_rate_including_null_collection_period %>%
                     drop_na(TIME_INTERVAL))$STAY_ID)) %>%
  {n_distinct(.$STAY_ID)}
```

\

**Count total ICU days of UO monitoring for icu stays with time intervals:**

```{r}
hourly_uo %>%
  filter(STAY_ID %in%
           (uo_rate_including_null_collection_period %>%
                     drop_na(TIME_INTERVAL))$STAY_ID) %>%
  nrow() / 24
```

\ 

**Hours of UO monitoring:**

```{r}
print("Hours of UO monitoring in all included ICU stays:")
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  nrow()

print("Valid hourly-adjusted UO monitoring hours:")
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
  nrow()

print("ICU stays with valid hourly-adjusted UO monitoring hours:")
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
  {n_distinct(.$STAY_ID)}
```

\


**Proportion of valid hours covered out of included hours of uo monitoring:**

```{r}
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
  nrow() /
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  nrow()
```

\ 

**Hourly-adjusted UO with admission weights:**

```{r}
print("ICU stays with weight at admission and valid hourly-adjusted UO:")
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
  drop_na(WEIGHT_ADMIT) %>%
  {n_distinct(.$STAY_ID)}

print("Valid hourly-adjusted UO monitoring hours with weight at admission:")
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
  drop_na(WEIGHT_ADMIT) %>%
  nrow()

print("ICU stays with valid weight (25 <= kg <=300) and valid hourly-adjusted UO:")
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
  filter(WEIGHT_ADMIT <= 300,
         WEIGHT_ADMIT >= 25) %>%
  {n_distinct(.$STAY_ID)}

print("Valid hourly-adjusted UO monitoring hours with valid weights:")
hourly_uo %>%
  filter(STAY_ID %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
  filter(WEIGHT_ADMIT <= 300,
         WEIGHT_ADMIT >= 25) %>%
  nrow()
```

\

**ICU stays with calculated KDIGO-UO staging (at least six consecutive hours with valid charting of hourly-adjusted UO)**

```{r}
print("number of ICU stays with valid KDIGO-UO staging")
kdigo_uo_stage %>% 
  filter(stay_id %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  filter(weight_admit <= 300,
         weight_admit >= 25) %>%
  {n_distinct(.$stay_id)}

print("number of included hours with valid KDIGO-UO staging")
kdigo_uo_stage %>% 
  filter(stay_id %in%
           (
             uo_rate_including_null_collection_period %>%
               drop_na(TIME_INTERVAL)
           )$STAY_ID) %>%
  filter(weight_admit <= 300,
         weight_admit >= 25) %>%
  nrow()
```

\

**eligible first ICU admission to each patient for AKI analysis**

```{r}
first_icu_stay <- dbGetQuery(con, "SELECT subject_id,
            ARRAY_AGG(
                STAY_ID
                ORDER BY
                    intime ASC
                LIMIT
                    1
            ) [OFFSET(0)] FIRST_STAY_ID_IN_PATIENT
        FROM
            `physionet-data.mimiciv_icu.icustays`
        GROUP BY
            subject_id")

print("number of first ICU stays with valid KDIGO-UO staging")
kdigo_uo_stage %>% 
  filter(stay_id %in% first_icu_stay$FIRST_STAY_ID_IN_PATIENT
         & stay_id %in% raw_uo_eligible$STAY_ID) %>%
  filter(weight_admit <= 300,
         weight_admit >= 25) %>%
  {n_distinct(.$stay_id)}

print("number of valid hourly KDIGO-UO staging in first ICU stays")
kdigo_uo_stage %>% 
  filter(stay_id %in% first_icu_stay$FIRST_STAY_ID_IN_PATIENT
         & stay_id %in% raw_uo_eligible$STAY_ID) %>%
  filter(weight_admit <= 300,
         weight_admit >= 25) %>%
  nrow()
```

**included ICU admissions for AKI analysis**

```{r}
print("number of first ICU stays (after exclusion criteria) with valid KDIGO-UO staging for the first 24-hours ins ICU stay")

aki_epi <- akis_all_long %>%
  filter(group == "newcons") %>%
  drop_na(prevalnce_admit) %>%
  transmute(STAY_ID,
           first_kdigo_uo = first_stage,
         max_uo_stage = max_stage)
  

kdigo_uo_stage %>% 
  filter(stay_id %in% aki_epi$STAY_ID) %>%
  filter(weight_admit <= 300,
         weight_admit >= 25) %>%
  {n_distinct(.$stay_id)}

print("number of valid hourly KDIGO-UO for those stays")
kdigo_uo_stage %>% 
  filter(stay_id %in% aki_epi$STAY_ID) %>%
  filter(weight_admit <= 300,
         weight_admit >= 25) %>%
  nrow()
```


## Inclusion/Exclusion Flowchart 

```{r}
knitr::include_graphics("flow chart.png")
```

## Table 1 - Patient's characteristics

```{r}
table_1$SERVICE <- as.factor(table_1$SERVICE)
table_1$admission_age <- as.numeric(table_1$admission_age)
table_1$weight_admit <- as.numeric(table_1$weight_admit)
table_1$height_first <- as.numeric(table_1$height_first)
table_1$creat_first <- as.numeric(table_1$creat_first)
table_1$creat_peak_72 <- as.numeric(table_1$creat_peak_72)
table_1$creat_last <- as.numeric(table_1$creat_last)

table_1 <- table_1 %>%
  mutate(
    race =
      case_when(
        grepl("asian", race, ignore.case = TRUE) ~ "Asian",
        grepl("black", race, ignore.case = TRUE) ~ "African American",
        grepl("white", race, ignore.case = TRUE) ~ "Caucasian",
        grepl("hispanic", race, ignore.case = TRUE) ~ "Hispanic",
        grepl("other", race, ignore.case = TRUE) ~ "Other",
        grepl("native", race, ignore.case = TRUE) ~ "Other",
        grepl("MULTIPLE", race, ignore.case = TRUE) ~ "Other",
        grepl("PORTUGUESE", race, ignore.case = TRUE) ~ "Other",
        grepl("SOUTH AMERICAN", race, ignore.case = TRUE) ~ "Other",
        TRUE ~ as.character(NA)
      )
  )

uo_for_table1 <- uo_rate_including_null_collection_period %>%
  drop_na(TIME_INTERVAL) %>%
  group_by(STAY_ID) %>%
  summarise(
    count = n(),
    volumes = mean(VALUE, na.rm = TRUE),
    collection_times = mean(TIME_INTERVAL, na.rm = TRUE),
    rates = mean(HOURLY_RATE, na.rm = TRUE),
    ml_kg_hr = mean(HOURLY_RATE / WEIGHT_ADMIT, na.rm = TRUE)
  )

t1a <- table_1 %>%
  select(
    admission_age,
    weight_admit,
    gender,
    race,
    charlson_comorbidity_index,
    ckd,
    dm,
    sofa_first_day,
    sapsii,
    apsiii,
    creat_first,
    creat_peak_72,
    creat_last,
    kdigo_cr_max,
    hospital_days,
    icu_days,
    rrt_binary,
    hospital_expire_flag
  ) %>%
  tbl_summary(
    type = list(
      c(hospital_expire_flag, ckd, dm, rrt_binary) ~ "dichotomous",
      c(
        admission_age,
        weight_admit,
        creat_first,
        creat_peak_72,
        creat_last
      ) ~ "continuous"
    ),
    statistic = c(
      admission_age,
      weight_admit,
      creat_first,
      creat_peak_72,
      creat_last
    ) ~ "{mean} ({sd})",
    missing = "no",
    label = list(
      admission_age ~ "Age at Hospital Admission, years",
      gender ~ "Gender",
      weight_admit ~ "Weight at ICU Admission, kg",
      charlson_comorbidity_index ~ "CCI Score",
      sofa_first_day ~ "SOFA Score at ICU Admission",
      ckd ~ "CKD, Stage 1-4",
      apsiii ~ "APS-III Score at ICU Admission",
      creat_first ~ "First Creatinine in ICU, mg/dL",
      creat_peak_72 ~ "Peak Creatinine at first days, mg/dL",
      creat_last ~ "ICU Discharge Creatinine, mg/dL",
      kdigo_cr_max ~ "Peak KDIGO-Cr at first days",
      race ~ "Ethnicity",
      icu_days ~ "Time in ICU, days",
      hospital_days ~ "Time in hospital, days",
      rrt_binary ~ "Renal replacement therapy",
      hospital_expire_flag ~ "Hospital Mortality",
      dm ~ "Diabetes Mellitus",
      sapsii ~ "SAPS-II at ICU Admission"
    )
  ) %>%
  add_n() 

display_prec <- function(x)
  mean(x) * 100

t1b <- uo_for_table1 %>%
  select(count,
         volumes,
         collection_times,
         rates,
         ml_kg_hr) %>%
  tbl_summary(
    type = list(
      c(volumes,
        collection_times,
        rates,
        ml_kg_hr) ~ "continuous"
    ),
    statistic = list(
      all_continuous() ~ "{mean} ({sd})"
    ),
    missing = "no",
    label = list(
      count ~ "Number of Measurements",
      volumes ~ "Average Volumes, mL",
      collection_times ~ "Average Collection Times, minutes",
      rates ~ "Average Rates, mL/hr",
      ml_kg_hr ~ "Average Rate to Weight, mL/hr/kg"
    )
  ) %>%
  add_n() 

tbl_stack(
  list(t1a, t1b),
  group_header = c("ICU Stay", "UO Charting Across ICU Stay")
) %>%
  as_gt() %>%
  tab_source_note(source_note = "The variables age at hospital admission, gender, CCI, CKD, ethnicity, time in hospital, and mortality are measured for each hospital admission and might be counted for more than one ICU stay. All other variables are measured individually for each ICU stay. The variables average collection times, average rates, and average rate to weight are only presented for ICU stays with at least two UO measurements for the same compartment, and the latter also required weight at admission. AKI variables were presented for ICU stays with at least one hour with a non-null KDIGO-UO stage. The variables average AKI duration and total time in AKI were specifically reported for ICU stays with at least one AKI event.") %>%
  tab_source_note(source_note = "AKI: Acute Kidney Injury; CCI: Charlson Comorbidity Index; CKD Stage 1-4: Chronic Kidney Disease excluding end-stage-renal-disease; ICU: Intensive Care Unit; KDIGO: Kidney Disease: Improving Global Outcomes; SOFA: Sequential Organ Failure Assessment; UO: Urine Output.")
```

\ 

## Age

```{r}
mimic_Sage_a <- table_1 %>%
  dplyr::summarise(N = n(),
                   Mean = round(mean(admission_age),2),
                   SD = round(sd(admission_age),2),
                   '5th' = round(quantile(admission_age, 0.05),2),
                   '10th' = round(quantile(admission_age, 0.1),2),
                   '25th' = round(quantile(admission_age, 0.25),2),
                   '50th' = round(quantile(admission_age, 0.50),2),
                   '75th' = round(quantile(admission_age, 0.75),2),
                   '95th' = round(quantile(admission_age, 0.95),2),
                   Min = round(min(admission_age),2),
                   Max = round(max(admission_age),2)
  ) %>% gt() %>%
  fmt_number(use_seps = TRUE, decimals = 2)
mimic_Sage_a
```

```{r}
mimic_Sage_b <- ggplot() + 
  geom_histogram(aes(x = admission_age
                     ), data=table_1, binwidth = 1) + 
  labs(
        x = "Age (years)",
        y = "Frequency"
      )

mimic_Sage_b
```

\ 

## Weight

```{r}
mimic_Sweight_a <- table_1 %>%
  drop_na(weight_admit) %>%
  dplyr::summarise(N = n(),
                   Mean = round(mean(weight_admit),2),
                   SD = round(sd(weight_admit),2),
                   '5th' = round(quantile(weight_admit, 0.05),2),
                   '10th' = round(quantile(weight_admit, 0.1),2),
                   '25th' = round(quantile(weight_admit, 0.25),2),
                   '50th' = round(quantile(weight_admit, 0.50),2),
                   '75th' = round(quantile(weight_admit, 0.75),2),
                   '95th' = round(quantile(weight_admit, 0.95),2),
                   Min = round(min(weight_admit),2),
                   Max = round(max(weight_admit),2)
  ) %>% gt() %>%
  fmt_number(use_seps = TRUE, decimals = 2)
mimic_Sweight_a
```

```{r}
mimic_Sweight_b <- ggplot() + 
  geom_histogram(aes(x = weight_admit
                     ), data=table_1, binwidth = 5) + 
  labs(
        # title = "Hourly-Adjusted UO per Kilogram",
        x = "Weight (kg)",
        y = "Frequency"
      ) +
  xlim(0, 300)

mimic_Sweight_b
```

\ 

## Table 2 - UO records characteristics

```{r}
uo_rate$SOURCE <- as.factor(uo_rate$SOURCE)
uo_rate$SERVICE <- as.factor(uo_rate$SERVICE)

uo_rate %>%
  select(VALUE, TIME_INTERVAL, SOURCE, SERVICE) %>%
  tbl_summary(by=SERVICE) %>%
  add_overall()
```

\ 

## Data for single patient example

The data that was used for single patient example.

### Raw UO records:

```{r}
raw_uo_as_character <- raw_uo %>%
  filter(STAY_ID == 36871275)
raw_uo_as_character[] <- lapply(raw_uo_as_character, as.character)

S2_a <- raw_uo_as_character %>%
  select(-SUBJECT_ID, -HADM_ID, -STAY_ID, -SERVICE) %>%
  arrange(., CHARTTIME) %>%
  slice_head(n=15) %>%
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)

S2_a
```

\ 

### UO Rates
```{r}
uo_rate %>%
  filter(STAY_ID == 36871275) %>%
  select(-HADM_ID, -STAY_ID, -WEIGHT_ADMIT, -SERVICE) %>%
  arrange(., CHARTTIME) %>%
  slice_head(n=20) %>%
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)
```

\ 

### Hourly-Adjusted UO
```{r}
hourly_uo %>%
  filter(STAY_ID == 36871275) %>%
  select(-STAY_ID, -WEIGHT_ADMIT) %>%
  arrange(., T_PLUS) %>%
  slice_head(n=20) %>%
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)
```

------------------------------------------------------------------------

# Raw data analysis

## Collection Periods

```{r}
S6_a <- uo_rate %>% group_by(SOURCE) %>%
   dplyr::summarise(N = n(),
                   Mean = round(mean(TIME_INTERVAL),0),
                   SD = round(sd(TIME_INTERVAL),0),
                   '5th' = round(quantile(TIME_INTERVAL, 0.05),0),
                   '10th' = round(quantile(TIME_INTERVAL, 0.1),0),
                   '25th' = round(quantile(TIME_INTERVAL, 0.25),0),
                   '50th' = round(quantile(TIME_INTERVAL, 0.50),0),
                   '75th' = round(quantile(TIME_INTERVAL, 0.75),0),
                   '95th' = round(quantile(TIME_INTERVAL, 0.95),0),
                   Min = round(min(TIME_INTERVAL),0),
                   Max = round(max(TIME_INTERVAL),0)
  ) %>% 
  arrange(desc(N)) %>% 
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)

S6_a
```


```{r}
S6_b <- ggplot(data = uo_rate, aes(x = TIME_INTERVAL / 60)) +
  geom_histogram(binwidth = 1) +
  facet_wrap(~factor(SOURCE, levels=c('Foley', 'Suprapubic', 'Ileoconduit',
                         'Void', 'Condom Cath', 'Straight Cath',
                         'R Nephrostomy', 'L Nephrostomy')), scales = "free") +
  xlim(-1, 20) +
  labs(
          x = "Time interval (hr)",
          y = "Frequency"
        ) 

S6_b
```

\ 

## Volumes and Collection Periods

```{r}
S7_a <- uo_rate %>% group_by(SOURCE) %>%
  dplyr::summarise(N = n(),
                   Mean = round(mean(VALUE),0),
                   SD = round(sd(VALUE),0),
                   '5th' = round(quantile(VALUE, 0.05),0),
                   '10th' = round(quantile(VALUE, 0.1),0),
                   '25th' = round(quantile(VALUE, 0.25),0),
                   '50th' = round(quantile(VALUE, 0.50),0),
                   '75th' = round(quantile(VALUE, 0.75),0),
                   '95th' = round(quantile(VALUE, 0.95),0),
                   Min = round(min(VALUE),0),
                   Max = round(max(VALUE),0)
  ) %>% 
  arrange(desc(N)) %>% 
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)

S7_a
```

```{r}
S7_b <- ggplot(data = uo_rate, aes(x = VALUE)) +
  facet_wrap(~factor(SOURCE, levels=c('Foley', 'Suprapubic', 'Ileoconduit',
                         'Void', 'Condom Cath', 'Straight Cath',
                         'R Nephrostomy', 'L Nephrostomy')), scales = "free") +
  geom_histogram(binwidth = 50) +
  xlim(-25, 1100) +
  labs(
        # title = "Volumes",
        x = "Volume (ml)",
        y = "Frequency"
      ) +
      theme(
        plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        plot.caption = element_text(face = "italic")
      )

S7_b
```

\ 

### Records of zero volume

**The proportion of zero value UO measurements:**

```{r}
uo_rate_count <- uo_rate %>% 
  count(SOURCE, sort = TRUE)

uo_rate_0_count <- uo_rate %>% 
  filter(VALUE == 0) %>% 
  count(SOURCE, sort = TRUE)

count_uo_zero_vs_all <- left_join(uo_rate_count, 
                                  uo_rate_0_count, by = "SOURCE") %>% 
  mutate(PROPORTION = n.y / n.x) %>%
  pivot_longer(cols = n.y:n.x, names_to = "type")
  
S7_c <- count_uo_zero_vs_all %>%
  ggplot(aes(x=reorder(SOURCE, -value), y=value, fill=type)) +
    geom_bar(position="fill", stat="identity") +
    xlab("") +
    ylab("") +
    scale_fill_brewer(palette="Paired") +  
    geom_text(aes(label=ifelse(type == "n.y", paste0((round(PROPORTION, 3) * 100), "%"), "")), 
          color="black", 
          size=3, 
          vjust=-1,
          position="fill") +
    theme_minimal() +
    theme(axis.text.y=element_blank()) +
    theme(legend.position="none") +
  theme(axis.text.y=element_blank()) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
     labs(
         # title = "Proportion of zero value raw output count",
       )
S7_c
```

```{r}
uo_rate_0 <- uo_rate %>% filter(VALUE == 0) 
S7_d <- uo_rate_0 %>% group_by(SOURCE) %>%
  dplyr::summarise(N = n(),
                   Mean = round(mean(TIME_INTERVAL),0),
                   SD = round(sd(TIME_INTERVAL),0),
                   '5th' = round(quantile(TIME_INTERVAL, 0.05),0),
                   '10th' = round(quantile(TIME_INTERVAL, 0.1),0),
                   '25th' = round(quantile(TIME_INTERVAL, 0.25),0),
                   '50th' = round(quantile(TIME_INTERVAL, 0.50),0),
                   '75th' = round(quantile(TIME_INTERVAL, 0.75),0),
                   '95th' = round(quantile(TIME_INTERVAL, 0.95),0),
                   Min = round(min(TIME_INTERVAL),0),
                   Max = round(max(TIME_INTERVAL),0)
  ) %>% 
  arrange(desc(N)) %>% 
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)

S7_d
```

------------------------------------------------------------------------

# Adjusting for hourly UO

## UO Rate

```{r}
S8_a <- uo_rate %>% group_by(SOURCE) %>%
    dplyr::summarise(N = n(),
                   Mean = round(mean(HOURLY_RATE),0),
                   SD = round(sd(HOURLY_RATE),0),
                   '5th' = round(quantile(HOURLY_RATE, 0.05),0),
                   '10th' = round(quantile(HOURLY_RATE, 0.1),0),
                   '25th' = round(quantile(HOURLY_RATE, 0.25),0),
                   '50th' = round(quantile(HOURLY_RATE, 0.50),0),
                   '75th' = round(quantile(HOURLY_RATE, 0.75),0),
                   '95th' = round(quantile(HOURLY_RATE, 0.95),0),
                   Min = round(min(HOURLY_RATE),0),
                   Max = round(max(HOURLY_RATE),0)
  ) %>% 
  arrange(desc(N)) %>% 
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)

S8_a
```

```{r}
S8_b <- ggplot(data = uo_rate, aes(x = HOURLY_RATE)) +
  geom_histogram(binwidth = 20) +
  facet_wrap(~factor(SOURCE, levels=c('Foley', 'Suprapubic', 'Ileoconduit',
                         'Void', 'Condom Cath', 'Straight Cath',
                         'R Nephrostomy', 'L Nephrostomy')), scales = "free") +  xlim(-10, 500) +
  labs(
        # title = "UO Rates",
        # subtitle = "by source",
        x = "Rate (ml/hr)",
        y = "Frequency"
      ) +
      theme(
        plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        plot.caption = element_text(face = "italic")
      )

S8_b
```

\ 

### Low UO Rate Analysis
The association between UO rates and collection periods, smoothed conditional means for records of Foley catheter.

```{r}
S8_d <- uo_rate %>%
  filter(SOURCE == "Foley",
         HOURLY_RATE < 500) %>%
  # slice_head(n = 50000) %>%
  ggplot(aes(x = HOURLY_RATE, y = TIME_INTERVAL)) +
  geom_smooth(se = TRUE, alpha = 0.1, linewidth = 1) +
  # geom_smooth(
  #   se = FALSE,
  #   method = "lm",
  #   linetype = "dashed",
  #   color = "red", 
  #   linewidth = 0.3
  # ) +
  geom_hline(yintercept = 60,
             size = 0.3,
             color = "#cccccc") +
  geom_vline(
    xintercept = 20,
    size = 0.3,
    color = "black",
    linetype = "dotdash"
  ) +
  scale_x_continuous(breaks = c(0, 20, 50, 100, 200, 300, 400, 500)) +
  scale_y_continuous(breaks = c(0, 60, 100, 200)) +
  coord_cartesian(xlim = c(0, 500), ylim = c(0, 200)) +
  labs(x = "Urine output rate (ml/hr)", y = "Collection periods (min)") +
  theme_classic()

S8_d
```

Quantile analysis for collection periods as a function of rates.

```{r, cache=TRUE}
uo_rate_qreg <- uo_rate %>%
  left_join(anchor_year, by = "HADM_ID") %>%
  filter(SOURCE == "Foley",
         HOURLY_RATE < 500,
         ANCHOR_START > 2016) %>%
  slice_head(n = 500000)

#### Quantile
quantile_reg <- rq(TIME_INTERVAL ~
                     HOURLY_RATE,
                   seq(0.10, 0.90, by = 0.10),
                   # c(.05, .1, .25, .5, .75, .90, .95),
                   data = uo_rate_qreg)

# summary(quantile_reg, se = "iid") %>% 
#   plot()
```

```{r}
### OLS
lm <- lm(data=uo_rate_qreg,
         formula =  TIME_INTERVAL ~
           HOURLY_RATE)

ols <- as.data.frame(coef(lm))
ols.ci <- as.data.frame(confint(lm, level = 0.95))
ols2 <- cbind(ols, ols.ci)
ols2 <- tibble::rownames_to_column(ols2, var="term")



#### Quantile
S8_e <- quantile_reg %>%
  tidy(se.type = "iid", conf.int = TRUE, conf.level = 0.95) %>%
  filter(!grepl("factor", term)) %>%
  ggplot(aes(x=tau,y=estimate)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    #strip.text.x = element_blank()
  ) +
  scale_y_continuous(limits = symmetric_limits) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 12)) +
  ##### quantilie results
  geom_point(color="#27408b", size = 0.3)+ 
  geom_line(color="black", linetype = "dotdash", size = 0.3)+ 
  geom_ribbon(aes(ymin=conf.low,ymax=conf.high),alpha=0.25, fill="#555555")+
  facet_wrap(~term, scales="free", ncol=1)+
  ##### OLS results
  geom_hline(data = ols2, aes(yintercept= `coef(lm)`), lty=1, color="red", size=0.3)+
  geom_hline(data = ols2, aes(yintercept= `2.5 %`), lty=2, color="red", size=0.3)+
  geom_hline(data = ols2, aes(yintercept= `97.5 %`), lty=2, color="red", size=0.3)+
  #### Lines
   geom_hline(yintercept = 0, size=0.3) 

S8_e
```


```{r}
# Visualization for Quantile Regression with some tau values: 
intercept_slope <- quantile_reg %>% 
  coef() %>% 
  t() %>% 
  data.frame() %>% 
  rename(intercept = X.Intercept., slope = HOURLY_RATE) %>% 
  mutate(quantile = row.names(.))


S8_f <-
  ggplot() +
  geom_jitter(data = uo_rate_qreg, aes(HOURLY_RATE, TIME_INTERVAL),
    alpha = 0.2,
    size = 0.5,
    stroke = 0.5,
    width = 2,
    height = 2
  ) +
  geom_abline(data = intercept_slope, aes(
    intercept = intercept,
    slope = slope,
    color = quantile
  ),
  linewidth=1) +
  theme_minimal() +
  labs(x = "Urine output rate (ml/hr)", y = "Collection periods (min)") +
  coord_cartesian(xlim = c(0, 500), ylim = c(0, 500))

S8_f
```

```{r, eval=FALSE}
uo_rate_qreg <- uo_rate %>%
  filter(SOURCE == "Foley") %>%
  arrange(STAY_ID) %>%
  slice_head(n = 500000)

percentile <- ecdf(uo_rate_qreg$TIME_INTERVAL)

#### Quantile
quantile_reg2 <- rq(TIME_INTERVAL ~ HOURLY_RATE, 
                    # seq(0.20, 0.80, by = 0.10), 
                    c(percentile(30),
                      percentile(60) - ((1-percentile(60))/10),
                      percentile(90),
                      percentile(120) - ((1-percentile(120))/10),
                      percentile(150),
                      percentile(180) - ((1-percentile(180))/10),
                      percentile(210),
                      percentile(240) - ((1-percentile(240))/10)),
                    data=uo_rate_qreg)

# Visualization for Quantile Regression with some tau values: 
intercept_slope <- quantile_reg2 %>% 
  coef() %>% 
  t() %>% 
  data.frame() %>% 
  rename(intercept = X.Intercept., slope = HOURLY_RATE) %>% 
  mutate(quantile = row.names(.))


ggplot() + 
  geom_point(data = uo_rate_qreg, aes(HOURLY_RATE, TIME_INTERVAL), 
             alpha = 0.5) + 
  geom_abline(data = intercept_slope, aes(intercept = intercept, slope = slope, color = quantile)) + 
  theme_minimal() + 
  labs(x = "HOURLY_RATE", y = "TIME_INTERVAL", 
       title = "Quantile Regression with tau = 0.25, 0.50 and 0.75", 
       caption = "Data Source: Koenker and Bassett (1982)") +
  coord_cartesian(xlim = c(0, 1000), ylim = c(0, 300))

```

\ 

**Collection periods for UO rate 20ml/hr or below**

```{r}
uo_rate %>% 
  filter(HOURLY_RATE <= 20) %>%
  group_by(SOURCE) %>%
   dplyr::summarise(N = n(),
                   Mean = round(mean(TIME_INTERVAL),0),
                   SD = round(sd(TIME_INTERVAL),0),
                   '5th' = round(quantile(TIME_INTERVAL, 0.05),0),
                   '10th' = round(quantile(TIME_INTERVAL, 0.1),0),
                   '25th' = round(quantile(TIME_INTERVAL, 0.25),0),
                   '50th' = round(quantile(TIME_INTERVAL, 0.50),0),
                   '75th' = round(quantile(TIME_INTERVAL, 0.75),0),
                   '95th' = round(quantile(TIME_INTERVAL, 0.95),0),
                   Min = round(min(TIME_INTERVAL),0),
                   Max = round(max(TIME_INTERVAL),0)
  ) %>% 
  arrange(desc(N)) %>% 
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)
```

```{r}
uo_rate %>% 
  filter(HOURLY_RATE <= 20) %>%
ggplot(aes(x = TIME_INTERVAL / 60)) +
  geom_histogram(binwidth = 1) +
  facet_wrap(~factor(SOURCE, levels=c('Foley', 'Suprapubic', 'Ileoconduit',
                         'Void', 'Condom Cath', 'Straight Cath',
                         'R Nephrostomy', 'L Nephrostomy')), scales = "free") +  xlim(-1, 20) +
  labs(
          title = "Collection periods for UO rate 20ml/hr or below",
          subtitle = "by source",
          x = "Time interval (hr)",
          y = "Frequency"
        ) +
        theme(
          plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
          plot.subtitle = element_text(size = 10, face = "bold"),
          plot.caption = element_text(face = "italic")
        )
```

\ 

### Mean Rate
**Mean UO rate weighted by tyme and grouped by source:**
```{r}
S8_c <- uo_rate %>% 
  group_by(SOURCE) %>%
  summarise(weighted_mean_rate = weighted.mean(HOURLY_RATE, TIME_INTERVAL)) %>%
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 1) %>%
  cols_label(
    SOURCE = "Source",
    weighted_mean_rate = "Weighted mean rate (ml/hr)"
  )

S8_c
```

\ 

## Hourly-adjusted UO

```{r}
S9_a <- hourly_uo %>% drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
    dplyr::summarise(N = n(),
                   Mean = round(mean(HOURLY_WEIGHTED_MEAN_RATE),0),
                   SD = round(sd(HOURLY_WEIGHTED_MEAN_RATE),0),
                   '5th' = round(quantile(HOURLY_WEIGHTED_MEAN_RATE, 0.05),0),
                   '10th' = round(quantile(HOURLY_WEIGHTED_MEAN_RATE, 0.1),0),
                   '25th' = round(quantile(HOURLY_WEIGHTED_MEAN_RATE, 0.25),0),
                   '50th' = round(quantile(HOURLY_WEIGHTED_MEAN_RATE, 0.50),0),
                   '75th' = round(quantile(HOURLY_WEIGHTED_MEAN_RATE, 0.75),0),
                   '95th' = round(quantile(HOURLY_WEIGHTED_MEAN_RATE, 0.95),0),
                   Min = round(min(HOURLY_WEIGHTED_MEAN_RATE),0),
                   Max = round(max(HOURLY_WEIGHTED_MEAN_RATE),0)
  ) %>% 
  arrange(desc(N)) %>% 
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 0)

S9_a
```

```{r}
S9_b <- hourly_uo %>% drop_na(HOURLY_WEIGHTED_MEAN_RATE) %>%
ggplot(aes(x = HOURLY_WEIGHTED_MEAN_RATE)) +
  geom_histogram(binwidth = 25) +
  xlim(-10, 500) + 
  labs(
        # title = "Hourly-Adjusted UO",
        x = "Hourly UO (ml)",
        y = "Frequency"
      )

S9_b
```

\ 

### Simple Sum Comparison
**Showing proportion of hours with less than  100ml difference):**

```{r}
adj_uo_diff <- hourly_uo %>%
  select(HOURLY_WEIGHTED_MEAN_RATE, SIMPLE_SUM) %>%
  filter(!is.na(HOURLY_WEIGHTED_MEAN_RATE)) %>%
  mutate(hourly_diff = abs(HOURLY_WEIGHTED_MEAN_RATE - SIMPLE_SUM)) %>%
  mutate(
    cutoff_10 = if_else(hourly_diff < 10, 1, 0),
    cutoff_50 = if_else(hourly_diff < 50, 1, 0),
    cutoff_100 = if_else(hourly_diff < 100, 1, 0),
    cutoff_150 = if_else(hourly_diff < 150, 1, 0),
    cutoff_200 = if_else(hourly_diff < 200, 1, 0)
  )

my_order <- c("<10", "<50", "<100", "<150", "<200")

S11 <- adj_uo_diff %>%
  select(cutoff_10,
         cutoff_50,
         cutoff_100,
         cutoff_150,
         cutoff_200) %>%
  pivot_longer(cols = contains("cutoff")) %>%
  transmute(name = case_when(
    name == "cutoff_10" ~ "<10",
    name == "cutoff_50" ~ "<50",
    name == "cutoff_100" ~ "<100",
    name == "cutoff_150" ~ "<150",
    name == "cutoff_200" ~ "<200"
  ),
  value) %>%
  group_by(name) %>%
  summarise(agreement = paste0(round(mean(value) * 100, 1), "%"),
            non_agreement = paste0(round((1 - mean(
              value
            )) * 100, 1), "%")) %>%
  arrange(match(name, my_order)) %>%
  gt() %>%
  # tab_header(
  #   title = md("**Comparison of Hourly-Adjusted UO and Simple Summation**"),
  # ) %>%
  cols_label(
    name = "Cut-off (ml)",
    agreement = "Proportion  of Agreement",
    non_agreement = "Proportion  of Disagreement"
  ) %>%
  cols_align(
    align = "center"
  ) %>%
  tab_source_note(source_note = "The table demonstrates the significance of hourly adjustment for accuracy by presenting the variance between the adjusted values and the simple hourly summation. Cut-off values are based on the absolute difference between the hourly-adjusted UO and a simple hourly summation of UO. Measurements charted on the hour were included with the previous time interval. ")

adj_uo_diff <- hourly_uo %>%
  select(HOURLY_WEIGHTED_MEAN_RATE, SIMPLE_SUM) %>%
  filter(!is.na(HOURLY_WEIGHTED_MEAN_RATE)) %>%
  mutate(no_diff = 
           ifelse((is.na(HOURLY_WEIGHTED_MEAN_RATE) &
                  is.na(SIMPLE_SUM)) |
             (!is.na(HOURLY_WEIGHTED_MEAN_RATE) &
                  !is.na(SIMPLE_SUM) &
                    abs(HOURLY_WEIGHTED_MEAN_RATE-SIMPLE_SUM) < 100), 
                  1, 
                  0),
         .keep = "none")

S11

mean(adj_uo_diff$no_diff)
```

\ 

### Hourly UO Per Kilogram

```{r}
S9_c <- uo_ml_kg_hr %>%
  filter(WEIGHT_ADMIT <= 300,
         WEIGHT_ADMIT >= 25) %>%
  dplyr::summarise(N = n(),
                   Mean = round(mean(ML_KG_HR),2),
                   SD = round(sd(ML_KG_HR),2),
                   '5th' = round(quantile(ML_KG_HR, 0.05),2),
                   '10th' = round(quantile(ML_KG_HR, 0.1),2),
                   '25th' = round(quantile(ML_KG_HR, 0.25),2),
                   '50th' = round(quantile(ML_KG_HR, 0.50),2),
                   '75th' = round(quantile(ML_KG_HR, 0.75),2),
                   '95th' = round(quantile(ML_KG_HR, 0.95),2),
                   Min = round(min(ML_KG_HR),2),
                   Max = round(max(ML_KG_HR),2)
  ) %>% 
  gt() %>%
  fmt_number(use_seps = TRUE, decimals = 2)

S9_c
```

```{r}
mean_log <- log(mean(uo_ml_kg_hr$ML_KG_HR))
sd_log <- log(sd(uo_ml_kg_hr$ML_KG_HR))
S9_d <- ggplot() + 
  xlim(0, 2) + 
  geom_histogram(aes(x = ML_KG_HR
                     # , y =..density..
                     ), data=(uo_ml_kg_hr %>%
                                filter(WEIGHT_ADMIT <= 300,
                                       WEIGHT_ADMIT >= 25)), 
                 binwidth = 0.02) + 
  # stat_function(fun = dlnorm, args = list(meanlog = mean_log, sdlog = sd_log, log = FALSE), size=1, color='gray') +
  labs(
        # title = "Hourly-Adjusted UO per Kilogram",
        x = "Hourly volume to kg (ml/hr/kg)",
        y = "Frequency"
      )

S9_d

# save(all_rows_count, 
#      distinct_time_item_patient_rows_count, 
#      S2_a,
#      S3a,
#      S4_a, S4_b, S4_c, S4_d, S4_e, S4_f,
#      S6_a, S6_b,
#      S7_a, S7_b, S7_c, S7_d, 
#      S8_a, S8_b, S8_c, S8_d, S8_e, S8_f,
#      S9_a, S9_b, S9_c, S9_d, 
#      file = "s_data.Rda")
```

------------------------------------------------------------------------

# KDIGO Criteria Avarage-UO, Consecutive-UO and Old (MIMIC repo. official deriviation) Comparison

```{r}
mimic_kdigo_inter_aki_table <- akis_all_long %>%
  drop_na(prevalnce_admit) %>%
  transmute(
    group = case_when(
      group == "newcons" ~ 'UO-Consecutive',
      group == "newmean" ~ 'UO-Average',
      group == "old" ~ 'Block summation'
    ),
    aki_binary = if_else(max_stage > 0, 1, 0),
    max_stage = if_else(max_stage == 0, NA, max_stage),
    prevalnce_admit
  ) %>%
  tbl_summary(
    by = "group",
    missing = "no",
    digits = everything() ~ c(0, 1),
    label = list(
      aki_binary ~ "Oliguric-AKI on the first days",
      prevalnce_admit ~ "Prevalence at admission",
      max_stage ~ "Maximum KDIGO staging"
    )
  )  %>%
  modify_column_indent(columns = label, rows = c(FALSE, TRUE)) %>%
  modify_column_indent(
    columns = label,
    rows = c(FALSE, FALSE, TRUE, TRUE, TRUE),
    double_indent = TRUE
  ) %>%
  add_p()

mimic_kdigo_inter_aki_table
```


```{r}
mimic_kdigo_inter_cons_mean <- akis_all_long %>%
  transmute(STAY_ID,
            group,
            first_stage,
            max_stage,
            aki_above_2 = max_stage > 1) %>%
  filter(aki_above_2 == TRUE,
         (group != "old")) %>%
  mutate(group = case_when(
    group == "newcons" ~ 'UO-Consecutive',
    group == "newmean" ~ 'UO-Average',
    group == "old" ~ 'Block summation'
  )) %>%
  left_join(table_1, by = "STAY_ID") %>%
  select(
    group,
    admission_age,
    weight_admit,
    gender,
    race,
    charlson_comorbidity_index,
    ckd,
    dm,
    sofa_first_day,
    sapsii,
    apsiii,
    creat_first,
    creat_peak_72,
    creat_last,
    kdigo_cr_max,
  # scr_baseline,
    hospital_days,
    icu_days,
    rrt_binary,
    hospital_expire_flag
  ) %>%
  tbl_summary(
    by = group,
    type = list(
      c(hospital_expire_flag,
        ckd,
        dm,
        rrt_binary) ~ "dichotomous",
      c(admission_age,
        weight_admit,
        creat_first,
        creat_peak_72,
        creat_last) ~ "continuous"
    ),
    statistic = c(admission_age,
                  weight_admit,
                  creat_first,
                  creat_peak_72,
                  creat_last) ~ "{mean} ({sd})",
    missing = "no",
    label = list(
      admission_age ~ "Age at Hospital Admission, years",
      gender ~ "Gender",
      weight_admit ~ "Weight at ICU Admission, kg",
      charlson_comorbidity_index ~ "CCI Score",
      sofa_first_day ~ "SOFA Score at ICU Admission",
      ckd ~ "CKD, Stage 1-4",
      apsiii ~ "APS-III Score at ICU Admission",
      creat_first ~ "First Creatinine in ICU, mg/dL",
      creat_peak_72 ~ "Peak Creatinine at first days, mg/dL",
      creat_last ~ "ICU Discharge Creatinine, mg/dL",
      kdigo_cr_max ~ "Peak KDIGO-Cr at first days",
      race ~ "Ethnicity",
      icu_days ~ "Time in ICU, days",
      hospital_days ~ "Time in hospital, days",
      rrt_binary ~ "Renal replacement therapy",
      hospital_expire_flag ~ "Hospital Mortality",
      dm ~ "Diabetes Mellitus",
      sapsii ~ "SAPS-II at ICU Admission"
    )
  ) %>%
  add_p() %>%
  add_stat(
    fns = everything() ~ add_by_n
  ) %>%
  modify_header(starts_with("add_n_stat") ~ "**N**") %>%
  modify_table_body(
    ~ .x %>%
      dplyr::relocate(add_n_stat_1, .before = stat_1) %>%
      dplyr::relocate(add_n_stat_2, .before = stat_2)
  )

mimic_kdigo_inter_mean_old <- akis_all_long %>%
  transmute(STAY_ID,
            group,
            first_stage,
            max_stage,
            aki_above_2 = max_stage > 1) %>%
  filter(aki_above_2 == TRUE,
         (group != "newcons")) %>%
  mutate(group = case_when(
    group == "newcons" ~ 'UO-Consecutive',
    group == "newmean" ~ 'UO-Average',
    group == "old" ~ 'Block summation'
  )) %>%
  left_join(table_1, by = "STAY_ID") %>%
  select(
    group,
    admission_age,
    weight_admit,
    gender,
    race,
    charlson_comorbidity_index,
    ckd,
    dm,
    sofa_first_day,
    sapsii,
    apsiii,
    creat_first,
    creat_peak_72,
    creat_last,
    kdigo_cr_max,
  # scr_baseline,
    hospital_days,
    icu_days,
    rrt_binary,
    hospital_expire_flag
  ) %>%
  tbl_summary(
    by = group,
    type = list(
      c(hospital_expire_flag,
        ckd,
        dm,
        rrt_binary,) ~ "dichotomous",
      c(admission_age,
        weight_admit,
        creat_first,
        creat_peak_72,
        creat_last) ~ "continuous"
    ),
    statistic = c(admission_age,
                  weight_admit,
                  creat_first,
                  creat_peak_72,
                  creat_last) ~ "{mean} ({sd})",
    missing = "no",
    label = list(
      admission_age ~ "Age at Hospital Admission, years",
      gender ~ "Gender",
      weight_admit ~ "Weight at ICU Admission, kg",
      charlson_comorbidity_index ~ "CCI Score",
      sofa_first_day ~ "SOFA Score at ICU Admission",
      ckd ~ "CKD, Stage 1-4",
      apsiii ~ "APS-III Score at ICU Admission",
      creat_first ~ "First Creatinine in ICU, mg/dL",
      creat_peak_72 ~ "Peak Creatinine at first days, mg/dL",
      creat_last ~ "ICU Discharge Creatinine, mg/dL",
      kdigo_cr_max ~ "Peak KDIGO-Cr at first days",
      race ~ "Ethnicity",
      icu_days ~ "Time in ICU, days",
      hospital_days ~ "Time in hospital, days",
      rrt_binary ~ "Renal replacement therapy",
      hospital_expire_flag ~ "Hospital Mortality",
      dm ~ "Diabetes Mellitus",
      sapsii ~ "SAPS-II at ICU Admission"
    )
  ) %>%
  add_p() %>%
  add_stat(
    fns = everything() ~ add_by_n
  ) %>%
  modify_header(starts_with("add_n_stat") ~ "**N**") %>%
  modify_table_body(
    ~ .x %>%
      dplyr::relocate(add_n_stat_1, .before = stat_1) %>%
      dplyr::relocate(add_n_stat_2, .before = stat_2)
  )

mimic_kdigo_inter_cons_old <- akis_all_long %>%
  transmute(STAY_ID,
            group,
            first_stage,
            max_stage,
            aki_above_2 = max_stage > 1) %>%
  filter(aki_above_2 == TRUE,
         (group != "newmean")) %>%
  mutate(group = case_when(
    group == "newcons" ~ 'UO-Consecutive',
    group == "newmean" ~ 'UO-Average',
    group == "old" ~ 'Block summation'
  )) %>%
  left_join(table_1, by = "STAY_ID") %>%
  select(
    group,
    admission_age,
    weight_admit,
    gender,
    race,
    charlson_comorbidity_index,
    ckd,
    dm,
    sofa_first_day,
    sapsii,
    apsiii,
    creat_first,
    creat_peak_72,
    creat_last,
    kdigo_cr_max,
  # scr_baseline,
    hospital_days,
    icu_days,
    rrt_binary,
    hospital_expire_flag
  ) %>%
  tbl_summary(
    by = group,
    type = list(
      c(hospital_expire_flag,
        ckd,
        dm,
        rrt_binary) ~ "dichotomous",
      c(admission_age,
        weight_admit,
        creat_first,
        creat_peak_72,
        creat_last) ~ "continuous"
    ),
    statistic = c(admission_age,
                  weight_admit,
                  creat_first,
                  creat_peak_72,
                  creat_last) ~ "{mean} ({sd})",
    missing = "no",
    label = list(
      admission_age ~ "Age at Hospital Admission, years",
      gender ~ "Gender",
      weight_admit ~ "Weight at ICU Admission, kg",
      charlson_comorbidity_index ~ "CCI Score",
      sofa_first_day ~ "SOFA Score at ICU Admission",
      ckd ~ "CKD, Stage 1-4",
      apsiii ~ "APS-III Score at ICU Admission",
      creat_first ~ "First Creatinine in ICU, mg/dL",
      creat_peak_72 ~ "Peak Creatinine at first days, mg/dL",
      creat_last ~ "ICU Discharge Creatinine, mg/dL",
      kdigo_cr_max ~ "Peak KDIGO-Cr at first days",
      race ~ "Ethnicity",
      icu_days ~ "Time in ICU, days",
      hospital_days ~ "Time in hospital, days",
      rrt_binary ~ "Renal replacement therapy",
      hospital_expire_flag ~ "Hospital Mortality",
      dm ~ "Diabetes Mellitus",
      sapsii ~ "SAPS-II at ICU Admission"
    )
  ) %>%
  add_p() %>%
  add_stat(
    fns = everything() ~ add_by_n
  ) %>%
  modify_header(starts_with("add_n_stat") ~ "**N**") %>%
  modify_table_body(
    ~ .x %>%
      dplyr::relocate(add_n_stat_1, .before = stat_1) %>%
      dplyr::relocate(add_n_stat_2, .before = stat_2)
  )

mimic_kdigo_inter_cons_mean
mimic_kdigo_inter_cons_old
mimic_kdigo_inter_mean_old
```

```{r}
akis_all_long %>%
  group_by(group, max_stage) %>%
  summarise(Propo = sum(mortality_7, na.rm = T) / n()) %>%
  ggplot(aes(max_stage, Propo, fill = group)) + geom_col(position = 'dodge')


mimic_cdplod_old <- cdplot(
  as.factor(mortality_7) ~ max_stage,
  (akis_all_long %>%
     filter(group == "old")),
  col = c("lightgoldenrod", "lightcyan"),
  ylab = "7 days mortality",
  xlab = "Max KDIGO-UO stage",
  main = "CD Plot for Block Summation"
)
mimic_cdplod_old

mimic_cdplod_mean <- cdplot(
  as.factor(mortality_7) ~ max_stage,
  (akis_all_long %>%
     filter(group == "newmean")),
  col = c("lightgoldenrod", "lightcyan"),
  ylab = "7 days mortality",
  xlab = "Max KDIGO-UO stage",
  main = "CD Plot for UOmean"
)
mimic_cdplod_mean

mimic_cdplod_cons <- cdplot(
  as.factor(mortality_7) ~ max_stage,
  (akis_all_long %>%
     filter(group == "newcons")),
  col = c("lightgoldenrod", "lightcyan"),
  ylab = "7 days mortality",
  xlab = "Max KDIGO-UO stage",
  main = "CD Plot for UOcons"
)
mimic_cdplod_cons


model_block_summation <- glm(
  mortality_7 ~ MAX_STAGE_OLD + FIRST_STAGE_OLD,
  data = akis_all_wide,
  family = binomial
)

model_mean <- glm(
  mortality_7 ~ MAX_STAGE_NEW_MEAN + FIRST_STAGE_NEW_MEAN,
  data = akis_all_wide,
  family = binomial
)

model_cons <- glm(
  mortality_7 ~ MAX_STAGE_NEW_CONS + FIRST_STAGE_NEW_CONS,
  data = akis_all_wide,
  family = binomial
)

# anova(model_old, model_new, test = 'Chisq')
mimic_kdigo_inter_bic <- BIC(model_block_summation, model_mean, model_cons)

mimic_kdigo_inter_bic <- cbind(Model = rownames(mimic_kdigo_inter_bic), mimic_kdigo_inter_bic) %>%
  gt()

mimic_kdigo_inter_bic
```

check for mortality overdispration:
```{r}
model_binom <- glm(
  mortality_30 ~ stage_newcons,
  family = binomial,
  data = (
    akis_all_long %>%
      filter(group == "newcons") %>%
      mutate(stage_newcons = as.factor(max_stage))
  )
)

model_overdispersed <- glm(
  mortality_30 ~ stage_newcons,
  family = quasibinomial,
  data = (
    akis_all_long %>%
      filter(group == "newcons") %>%
      mutate(stage_newcons = as.factor(max_stage))
  )
)

pchisq(summary(model_overdispersed)$dispersion * model_binom$df.residual, 
       model_binom$df.residual, lower = F)
```

```{r}
akis_all_long_complete <- akis_all_long %>% drop_na(max_stage)

# descriptive
descriptive_tbl <- akis_all_long_complete %>%
  group_by(group, max_stage) %>%
  summarise(
    n = n(),
    dead = sum(mortality_30),
    mortality_prop = sum(mortality_30) / n()
  ) %>%
  # drop_na() %>%
  group_by(group) %>%
  transmute(
    max_stage,
    "Patients, No. (%)" = paste0(n, " (", round((n / sum(
      n
    )), 2), ")"),
    "Mortality, No. (%)" = paste0(dead, " (", round(mortality_prop, 2), ")")
  ) %>%
  gt()

# glm
m1 <- glm(
  mortality_30 ~ stage_newcons,
  family = binomial,
  data = (
    akis_all_long_complete %>%
      filter(group == "newcons") %>%
      mutate(stage_newcons = as.factor(max_stage))
  )
)

m2 <- glm(
  mortality_30 ~ stage_newmean,
  family = binomial,
  data = (
    akis_all_long_complete %>%
      filter(group == "newmean") %>%
      mutate(stage_newmean = as.factor(max_stage))
  )
)

m3 <- glm(
  mortality_30 ~ stage_old,
  family = binomial,
  data = (
    akis_all_long_complete %>%
      filter(group == "old") %>%
      mutate(stage_old = as.factor(max_stage))
  )
)

tbl_regression

glm_tbl <- tbl_stack(list(
  tbl_regression(m1, exponentiate = TRUE),
  tbl_regression(m2, exponentiate = TRUE),
  tbl_regression(m3, exponentiate = TRUE)
)) %>%
  as_gt()

# join tables
glm_tbl_data <- glm_tbl$`_data` %>%
  filter(!is.na(term)) %>%
  transmute(
    group = case_when(
      variable == "stage_newmean" ~ "newmean",
      variable == "stage_newcons" ~ "newcons",
      variable == "stage_old" ~ "old"
    ),
    max_stage = label,
    "OR (95% CI)" = if_else(label == "0", "1 [Reference]", paste0(round(estimate, 2), " (", ci, ")"), ),
    "P value" = case_when(
      is.na(p.value) ~ "NA",
      p.value < 0.001 ~ "<.001",
      .default = as.character(round(p.value, 2))
    )
  )

descriptive_tbl_data <- descriptive_tbl$`_data` %>%
  mutate(max_stage = as.character(max_stage))

rr_table_data <- left_join(descriptive_tbl_data, glm_tbl_data, by = c("group", "max_stage"))

mimic_kdigo_inter_survival_table <- rr_table_data %>%
  mutate(
    group = case_when(
      group == "newcons" ~ 'UO-Consecutive',
      group == "newmean" ~ 'UO-Average',
      group == "old" ~ 'Block summation'
    )
  ) %>%
  gt(
    rowname_col = "max_stage",
    groupname_col = "group",
    row_group_as_column = TRUE
  ) %>%
  tab_stubhead(label = "Criteria / Stage") %>%
  tab_spanner(label = "Unadjusted OR", columns = c("OR (95% CI)", "P value"))

mimic_kdigo_inter_survival_table
```

adjusted models:
```{r}
m1_adj1 <- glm(
  mortality_30 ~ stage_newcons * (
    admission_age + gender + weight_admit + first_stage
  ),
  family = binomial,
  data = (
    akis_all_long_complete %>%
      filter(group == "newcons") %>%
      mutate(stage_newcons = as.factor(max_stage))
  )
)

mrg_efct_m1_adj1 <- avg_comparisons(
  m1_adj1,
  variables = "stage_newcons",
  comparison = "lnoravg",
  transform = exp
)

rr_table_data_m1_adj1 <- mrg_efct_m1_adj1 %>%
    transmute(
      group = "newcons",
      max_stage = as.factor(dplyr::row_number()),
      estimate = paste0(round(estimate, 2), " (",round(conf.low, 2), "-", round(conf.high, 2), ")"),
      p.value
    ) %>% add_row(group = "newcons", max_stage = "0", .before = 0) %>%
    transmute(
    group,
    max_stage,
    or.adj1 = if_else(is.na(estimate), "1 [Reference]", estimate),
    p.adj1 = case_when(
      is.na(p.value) ~ "NA",
      p.value < 0.001 ~ "<.001",
      .default = as.character(round(p.value, 2))
    )
  )

m2_adj1 <- glm(
  mortality_30 ~ stage_newmean * (
    admission_age + weight_admit + gender + first_stage
  ),
  family = binomial,
  data = (
    akis_all_long_complete %>%
      filter(group == "newmean") %>%
      mutate(stage_newmean = as.factor(max_stage))
  )
)

mrg_efct_m2_adj1 <- avg_comparisons(
  m2_adj1,
  variables = "stage_newmean",
  comparison = "lnoravg",
  transform = exp
)

rr_table_data_m2_adj1 <- mrg_efct_m2_adj1 %>%
    transmute(
      group = "newmean",
      max_stage = as.factor(dplyr::row_number()),
      estimate = paste0(round(estimate, 2), " (",round(conf.low, 2), "-", round(conf.high, 2), ")"),
      p.value
    ) %>% add_row(group = "newmean", max_stage = "0", .before = 0) %>%
    transmute(
    group,
    max_stage,
    or.adj1 = if_else(is.na(estimate), "1 [Reference]", estimate),
    p.adj1 = case_when(
      is.na(p.value) ~ "NA",
      p.value < 0.001 ~ "<.001",
      .default = as.character(round(p.value, 2))
    )
  )

m3_adj1 <- glm(
  mortality_30 ~ stage_old * (
    admission_age + weight_admit + gender + first_stage
  ),
  family = binomial,
  data = (
    akis_all_long_complete %>%
      filter(group == "old") %>%
      mutate(stage_old = as.factor(max_stage))
  )
)

mrg_efct_m3_adj1 <- avg_comparisons(
  m3_adj1,
  variables = "stage_old",
  comparison = "lnoravg",
  transform = exp
)

rr_table_data_m3_adj1 <- mrg_efct_m3_adj1 %>%
    transmute(
      group = "old",
      max_stage = as.factor(dplyr::row_number()),
      estimate = paste0(round(estimate, 2), " (",round(conf.low, 2), "-", round(conf.high, 2), ")"),
      p.value
    ) %>% add_row(group = "old", max_stage = "0", .before = 0) %>%
    transmute(
    group,
    max_stage,
    or.adj1 = if_else(is.na(estimate), "1 [Reference]", estimate),
    p.adj1 = case_when(
      is.na(p.value) ~ "NA",
      p.value < 0.001 ~ "<.001",
      .default = as.character(round(p.value, 2))
    )
  )

mimic_kdigo_inter_survival_table_adj <- rr_table_data %>% 
  left_join(bind_rows(rr_table_data_m1_adj1, rr_table_data_m2_adj1, rr_table_data_m3_adj1)) %>%
  mutate(
    group = case_when(
      group == "newcons" ~ 'UO-Consecutive',
      group == "newmean" ~ 'UO-Average',
      group == "old" ~ 'Block summation'
    )
  ) %>%
  gt(
    rowname_col = "max_stage",
    groupname_col = "group",
    row_group_as_column = TRUE
  ) %>%
  cols_label(
    or.adj1 = "OR (95% CI)",
    p.adj1 = "P value",
  ) %>%
  tab_stubhead(label = "Criteria / Stage") %>%
  tab_spanner(label = "Unadjusted OR", columns = c("OR (95% CI)", "P value")) %>%
  tab_spanner(label = "Adjusted Model", columns = c(or.adj1, p.adj1), id = "adj1") %>%
  tab_footnote(
    footnote = "Model include age, weight, gender and whether diagnosed on admission",
    locations = cells_column_spanners(spanners = "adj1")
  ) %>% tab_source_note(source_note = md(
    "All covariates in the adjusted model were significant except for diagnosis at admission for block summation model."
  ))

mimic_kdigo_inter_survival_table_adj
```

summaries for all tables:
```{r}
summary(m1_adj1)
summary(m2_adj1)
summary(m3_adj1)
```


```{r}
km_fit_newcons <-
  survfit(Surv(FOLLOWUP_DAYS, DEATH_FLAG) ~ MAX_STAGE_NEW_CONS,
          akis_all_wide)

km_fit_newmean <-
  survfit(Surv(FOLLOWUP_DAYS, DEATH_FLAG) ~ MAX_STAGE_NEW_MEAN,
          akis_all_wide)

km_fit_old <-
  survfit(Surv(FOLLOWUP_DAYS, DEATH_FLAG) ~ MAX_STAGE_OLD,
          akis_all_wide)

mimic_survival_figure_newcons <- km_fit_newcons %>%
ggsurvfit(linewidth = 1) +
  add_confidence_interval() +
  add_quantile() +
  scale_ggsurvfit(x_scales = list(breaks = seq(0, 30, by = 5))) +
  coord_cartesian(xlim = c(0, 30)) +
  theme_classic() +
  scale_fill_discrete(labels=c('0', '1', '2', '3')) +
  scale_color_discrete(labels=c('0', '1', '2', '3')) +
  labs(x="Days", y = "Survival", title = "UOcons",
       color='Maximum KDIGO-UO stage', fill='Maximum KDIGO-UO stage') +
  theme(legend.position = "bottom")

mimic_survival_figure_newmean <- km_fit_newmean %>%
ggsurvfit(linewidth = 1) +
  add_confidence_interval() +
  add_quantile() +
  scale_ggsurvfit(x_scales = list(breaks = seq(0, 30, by = 5))) +
  coord_cartesian(xlim = c(0, 30)) +
  theme_classic() +
  scale_fill_discrete(labels=c('0', '1', '2', '3')) +
  scale_color_discrete(labels=c('0', '1', '2', '3')) +
  labs(x="Days", y = "Survival", title = "UOmean",
       color='Maximum KDIGO-UO stage', fill='Maximum KDIGO-UO stage') +
  theme(legend.position = "bottom")

mimic_survival_figure_old <- km_fit_old %>%
ggsurvfit(linewidth = 1) +
  add_confidence_interval() +
  add_quantile() +
  scale_ggsurvfit(x_scales = list(breaks = seq(0, 30, by = 5))) +
  coord_cartesian(xlim = c(0, 30)) +
  theme_classic() +
  scale_fill_discrete(labels=c('0', '1', '2', '3')) +
  scale_color_discrete(labels=c('0', '1', '2', '3')) +
  labs(x="Days", y = "Survival",title = "Block Summation",
       color='Maximum KDIGO-UO stage', fill='Maximum KDIGO-UO stage') +
  theme(legend.position = "bottom")

mimic_kdigo_inter_survival_figure <- ggarrange(
  mimic_survival_figure_old,
  mimic_survival_figure_newmean,
  mimic_survival_figure_newcons,
  ncol = 1,
  nrow = 3,
  legend = "bottom",
  common.legend = TRUE
) %>% annotate_figure(top = text_grob("MIMICdb", face = "bold", size = 14))

mimic_kdigo_inter_survival_figure
```


# Sensitivity Analysis: Validity Threshold for Durations of Collection

```{r create data for threshold analysis, include=FALSE, cache=TRUE}
dbSendQuery(con, statement = read_file('sql/validate cutoff/b_uo_rate_temp.sql'))

dbSendQuery(con, statement = read_file('sql/validate cutoff/c_hourly_uo_9520_temp.sql'))
dbSendQuery(con, statement = read_file('sql/validate cutoff/d1_kdigo_uo_9520_temp.sql'))
dbSendQuery(con, statement = read_file('sql/validate cutoff/d3_kdigo_stages_9520_temp.sql'))

dbSendQuery(con, statement = read_file('sql/validate cutoff/c_hourly_uo_9920_temp.sql'))
dbSendQuery(con, statement = read_file('sql/validate cutoff/d1_kdigo_uo_9920_temp.sql'))
dbSendQuery(con, statement = read_file('sql/validate cutoff/d3_kdigo_stages_9920_temp.sql'))

validity_threshold_wide <- dbGetQuery(con, statement = read_file('sql/validity trashold.sql')) %>%
    filter(WEIGHT_ADMIT <= 300,
           WEIGHT_ADMIT >= 25)

dbSendQuery(con, "DROP TABLE IF EXISTS`mimic_uo_and_aki.b_uo_rate_temp`")

dbSendQuery(con, "DROP TABLE IF EXISTS`mimic_uo_and_aki.c_hourly_uo_9520_temp`")
dbSendQuery(con, "DROP TABLE IF EXISTS `mimic_uo_and_aki.d1_kdigo_uo_9520_temp`")
dbSendQuery(con, "DROP TABLE IF EXISTS`mimic_uo_and_aki.d3_kdigo_stages_9520_temp`")

dbSendQuery(con, "DROP TABLE IF EXISTS`mimic_uo_and_aki.c_hourly_uo_9920_temp`")
dbSendQuery(con, "DROP TABLE IF EXISTS `mimic_uo_and_aki.d1_kdigo_uo_9920_temp`")
dbSendQuery(con, "DROP TABLE IF EXISTS`mimic_uo_and_aki.d3_kdigo_stages_9920_temp`")
```


```{r}
validity_threshold_long <- validity_threshold_wide %>%
  mutate(
         first_stage.cons = FIRST_STAGE_NEW_CONS,
         first_stage.9520 = FIRST_STAGE_NEW_CONS_95_20,
         first_stage.9920 = FIRST_STAGE_NEW_CONS_99_20,
         max_stage.cons = MAX_STAGE_NEW_CONS,
         max_stage.9520 = MAX_STAGE_NEW_CONS_95_20,
         max_stage.9920 = MAX_STAGE_NEW_CONS_99_20,
         .keep = "unused") %>%
  pivot_longer(
    !c(STAY_ID, FOLLOWUP_DAYS, DEATH_FLAG),
    names_sep = "\\.",
    names_to = c(".value", "group")
  ) %>%
  mutate(
    mortality_90 = if_else(FOLLOWUP_DAYS < 91 &
                                 DEATH_FLAG == 1, 1, 0),
    prevalnce_admit = if_else(first_stage > 0, 1, 0),
    Incidence_first_72hr = case_when(first_stage > 0 ~ NA, max_stage == 0 ~ 0, max_stage > 0 ~ 1),
    Incidence_first_72hr_with_stage = ifelse(first_stage == 0 &
                                              max_stage > 0, max_stage, NA),
    .keep = "all"
  ) 

validity_threshold_long %>%
  drop_na(prevalnce_admit) %>%
  transmute(
    group,
    aki_binary = if_else(max_stage > 0, 1, 0),
    max_stage = if_else(max_stage == 0, NA, max_stage),
    prevalnce_admit
  ) %>%
  mutate(group =
           case_when(group == "cons" ~ "No exclusion",
                     group == "9520" ~ "95th precentile for rate bellow 20th precentile",
                     group == "9920" ~ "99th precentile for rate bellow 20th precentile")) %>%
  tbl_summary(
    by = "group",
    missing = "no",
    digits = everything() ~ c(0, 1),
    label = list(
      aki_binary ~ "Oliguric-AKI on the first days",
      prevalnce_admit ~ "Prevalence at admission",
      max_stage ~ "Maximum KDIGO staging"
    )
  )  %>%
  modify_column_indent(columns = label, rows = c(FALSE, TRUE)) %>%
  modify_column_indent(
    columns = label,
    rows = c(FALSE, FALSE, TRUE, TRUE, TRUE),
    double_indent = TRUE
  ) %>%
  add_p()
```

```{r}
mimic_exclusion_threshold <- validity_threshold_long %>%
  transmute(STAY_ID,
            group,
            first_stage,
            max_stage,
            aki_above_2 = max_stage > 1) %>%
  filter(aki_above_2 == TRUE,
         (group == "cons" | group == "9520" | group == "9920")) %>%
  left_join(table_1, by = "STAY_ID") %>%
    mutate(group =
           case_when(group == "cons" ~ "No exclusion",
                     group == "9520" ~ "95th precentile for rate bellow 20th precentile",
                     group == "9920" ~ "99th precentile for rate bellow 20th precentile")) %>%
  select(
    group,
    admission_age,
    weight_admit,
    gender,
    race,
    charlson_comorbidity_index,
    ckd,
    dm,
    sofa_first_day,
    sapsii,
    apsiii,
    creat_first,
    creat_peak_72,
    creat_last,
    kdigo_cr_max,
  # scr_baseline,
    hospital_days,
    icu_days,
    rrt_binary,
    hospital_expire_flag
  ) %>%
  tbl_summary(
    by = group,
    type = list(
      c(hospital_expire_flag,
        ckd,
        dm,
        rrt_binary) ~ "dichotomous",
      c(admission_age,
        weight_admit,
        creat_first,
        creat_peak_72,
        creat_last) ~ "continuous"
    ),
    statistic = c(admission_age,
                  weight_admit,
                  creat_first,
                  creat_peak_72,
                  creat_last) ~ "{mean} ({sd})",
    missing = "no",
    label = list(
      admission_age ~ "Age at Hospital Admission, years",
      gender ~ "Gender",
      weight_admit ~ "Weight at ICU Admission, kg",
      charlson_comorbidity_index ~ "CCI Score",
      sofa_first_day ~ "SOFA Score at ICU Admission",
      ckd ~ "CKD, Stage 1-4",
      apsiii ~ "APS-III Score at ICU Admission",
      creat_first ~ "First Creatinine in ICU, mg/dL",
      creat_peak_72 ~ "Peak Creatinine at first days, mg/dL",
      creat_last ~ "ICU Discharge Creatinine, mg/dL",
      kdigo_cr_max ~ "Peak KDIGO-Cr at first days",
      race ~ "Ethnicity",
      icu_days ~ "Time in ICU, days",
      hospital_days ~ "Time in hospital, days",
      rrt_binary ~ "Renal replacement therapy",
      hospital_expire_flag ~ "Hospital Mortality",
      dm ~ "Diabetes Mellitus",
      sapsii ~ "SAPS-II at ICU Admission"
    )
  ) %>%
  add_p() %>%
  add_stat(
    fns = everything() ~ add_by_n
  ) %>%
  modify_header(starts_with("add_n_stat") ~ "**N**") %>%
  modify_table_body(
    ~ .x %>%
      dplyr::relocate(add_n_stat_1, .before = stat_1) %>%
      dplyr::relocate(add_n_stat_2, .before = stat_2) %>%
      dplyr::relocate(add_n_stat_3, .before = stat_3)
  )

mimic_exclusion_threshold
```

# Clinical Outcomes

Describing the prevalence of oliguric-AKI upon admission and incidence at the first ICU day

```{r}
akis_all_long %>%
  filter(group == "newcons") %>%
  select(prevalnce_admit,
         Incidence_first_72hr,
         max_stage) %>%
  drop_na(prevalnce_admit) %>%
  transmute(
    aki_binary = if_else(max_stage > 0, 1, 0),
    max_stage = if_else(max_stage == 0, NA, max_stage),
    prevalnce_admit
  ) %>%
  tbl_summary(
    missing = "no",
    digits = everything() ~ c(0, 1),
    label = list(
      aki_binary ~ "Oliguric-AKI on the first days",
      prevalnce_admit ~ "Prevalence at admission",
      max_stage ~ "Maximum KDIGO staging"
    )
  ) %>%
  modify_column_indent(columns = label, 
                       rows = c(FALSE, TRUE)) %>%
  modify_column_indent(columns = label, 
                       rows = c(FALSE, FALSE, TRUE, TRUE, TRUE),
                       double_indent = TRUE)
```

```{r}
aki_uo_analysis <- left_join(akis_all_wide, uo_ml_kg_hr, by = "STAY_ID") %>%
  drop_na(FIRST_POSITIVE_STAGE_UO_CONS_TIME, 
          TIME_INTERVAL_FINISH, 
          MAX_STAGE_NEW_CONS) %>%
  transmute(STAY_ID,
         MAX_STAGE_NEW_CONS = as.character(MAX_STAGE_NEW_CONS),
         FIRST_POSITIVE_STAGE_UO_CONS_TIME,
         TIME_INTERVAL_FINISH,
         UO_KG = ML_KG_HR
         ) %>%
  mutate(TIME = as.double(difftime(TIME_INTERVAL_FINISH, 
                                   FIRST_POSITIVE_STAGE_UO_CONS_TIME, 
                                   units = c("hour")))) %>%
  filter(TIME >= -48 & TIME <= 48)

aki_creat_analysis <- left_join(akis_all_wide, creat_diff %>% select(-STAY_ID), by = "HADM_ID") %>%
  select(STAY_ID,
         MAX_STAGE_NEW_CONS,
         FIRST_STAGE_NEW_CONS,
         FIRST_POSITIVE_STAGE_UO_CONS_TIME,
         CHARTTIME,
         CREAT,
         SCR_BASELINE,
         CREAT_BASLINE_DIFF,
         CREAT_BASLINE_RATIO,
         CREAT_LOWEST7_DIFF,
         CREAT_LOWEST7_RATIO
         ) %>%
  mutate(AKI_TO_CREAT = as.double(difftime(CHARTTIME, 
                                   FIRST_POSITIVE_STAGE_UO_CONS_TIME, 
                                   units = c("mins"))) / 60) %>%
  filter(AKI_TO_CREAT >= -72 & AKI_TO_CREAT <= 72)
```

## First Oliguric-AKI Events

table 1 for ICU stays with identified oliguric AKI in the first 72 hours of admission, stratified by max kdigo-uo stage (ICU stays with AKI at admission were excluded):

```{r}
table1_akis <- akis_all_wide  %>%
  filter(MAX_STAGE_NEW_CONS >= 0) %>%
  select(STAY_ID, MAX_STAGE_NEW_CONS) %>%
  left_join(table_1, by = "STAY_ID")

table_1_staging <- table1_akis %>%
  select(
    MAX_STAGE_NEW_CONS,
    admission_age,
    weight_admit,
    gender,
    race,
    charlson_comorbidity_index,
    ckd,
    dm,
    sofa_first_day,
    sapsii,
    apsiii,
    creat_first,
    creat_peak_72,
    creat_last,
    kdigo_cr_max,
    hospital_days,
    icu_days,
    rrt_binary,
    hospital_expire_flag
  ) %>%
  mutate(
    staging = case_when(
      MAX_STAGE_NEW_CONS == 0 ~ "No AKI",
      MAX_STAGE_NEW_CONS == 1 ~ "Stage 1",
      MAX_STAGE_NEW_CONS == 2 ~ "Stage 2",
      MAX_STAGE_NEW_CONS == 3 ~ "Stage 3",
      .default = NA
    ),
    .keep = "unused"
  ) %>%
  tbl_summary(
    by = staging,
    type = list(
      c(hospital_expire_flag, ckd, dm, rrt_binary) ~ "dichotomous",
      c(
        admission_age,
        weight_admit,
        creat_first,
        creat_peak_72,
        creat_last
      ) ~ "continuous"
    ),
    statistic = c(
      admission_age,
      weight_admit,
      creat_first,
      creat_peak_72,
      creat_last
    ) ~ "{mean} ({sd})",
    missing = "no",
    missing_text = "-",
    digits = list(hospital_days ~ c(1, 1)),
    label = list(
      admission_age ~ "Age at Hospital Admission, years",
      gender ~ "Gender",
      weight_admit ~ "Weight at ICU Admission, kg",
      charlson_comorbidity_index ~ "CCI Score",
      sofa_first_day ~ "SOFA Score at ICU Admission",
      ckd ~ "CKD, Stage 1-4",
      apsiii ~ "APS-III Score at ICU Admission",
      creat_first ~ "First Creatinine in ICU, mg/dL",
      creat_peak_72 ~ "Peak Creatinine at first days, mg/dL",
      creat_last ~ "ICU Discharge Creatinine, mg/dL",
      kdigo_cr_max ~ "Peak KDIGO-Cr at first days",
      race ~ "Ethnicity",
      icu_days ~ "Time in ICU, days",
      hospital_days ~ "Time in hospital, days",
      rrt_binary ~ "Renal replacement therapy",
      hospital_expire_flag ~ "Hospital Mortality",
      dm ~ "Diabetes Mellitus",
      sapsii ~ "SAPS-II at ICU Admission"
    )
  ) %>%
  add_p(c(
    admission_age,
    weight_admit,
    creat_first,
    creat_peak_72,
    creat_last
  ) ~ "aov")

table_1_staging 
```

UO onset at UOcons event:

```{r}
mimic_uo_cons_figure <- aki_uo_analysis %>% 
ggplot(aes(TIME, UO_KG, color=MAX_STAGE_NEW_CONS, fill=MAX_STAGE_NEW_CONS))  + 
           # linetype=MAX_STAGE_NEW_CONS))  + 
  geom_hline(yintercept=0.3, size = 0.3, color = "#cccccc") +
  geom_hline(yintercept=0.5, size = 0.3, color = "#cccccc") +
  geom_vline(xintercept=0, size = 0.3, color = "black", linetype = "dashed") +
  stat_summary(fun = median, geom="line") +
  scale_x_continuous(breaks = seq(-24, 48, by=6)) +
  scale_y_continuous(breaks = c(0, 0.3, 0.5)) +
  coord_cartesian(xlim = c(-12, 24), ylim = c(0, 1.7)) +
  # xlim(-24, 48) +
  stat_summary(fun.min = function(z) { quantile(z,0.25) },
               fun.max = function(z) { quantile(z,0.75) },
               geom="ribbon", colour = NA, alpha=0.2) +
  labs(x="Time around AKI onset (hour)", y = "Urine output (ml/kg/hr)", 
       color="Maximum KDIGO-UO stage", fill="Maximum KDIGO-UO stage") + 
  theme_classic() + # remove panel background and gridlines
  scale_color_manual(values = pal_jama("default")(4)[2:4]) +
  scale_fill_manual(values = pal_jama("default")(4)[2:4]) +
  theme(
    legend.position = "none"
  )

mimic_uo_cons_figure
```

## Serum Creatinine Analysis
```{r}
aki_creat_analysis %>%
ggplot(aes(x=CREAT_BASLINE_DIFF)) + 
    xlim(0, 5) + 
    geom_histogram(binwidth = 0.1)
```

```{r}
mimic_creat_a <- aki_creat_analysis %>% 
  filter(MAX_STAGE_NEW_CONS == 1,
         AKI_TO_CREAT >= -24,
         AKI_TO_CREAT <= 48) %>%
  mutate(AKI_TO_CREAT_BIN = cut(AKI_TO_CREAT, 
                                breaks=12, 
                                ordered_result = TRUE,
                                # labels=FALSE
                                )) %>%
ggplot(aes(factor(AKI_TO_CREAT_BIN), CREAT_LOWEST7_DIFF)) +
    geom_boxplot(linetype = "dashed", outlier.shape = NA, color="brown") +
    stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = NA, color="brown", fill="orange") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..), color="brown") +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..), color="brown") +
    stat_summary(fun.y=mean, colour="darkred", geom="point", hape=18, size=2,show_guide = FALSE) +
    # scale_x_discrete(labels=c('-24      ','-18      ','-12      ','-6      ','0      ','6      ','12      ','18      ','24      ','30      ','36      ','42      ','48      ')) +
    labs(x=" ", y = "Difference from basline (mg/dL)") +
    coord_cartesian(ylim = c(-0.1, 3)) +
    theme_classic() + # remove panel background and gridlines
    theme(legend.position = "bottom",
          plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
          plot.subtitle = element_text(size = 10, face = "bold"),
          # axis.text.x = element_text(margin = margin(t = 2),
          #                            hjust="1")
          ) +
  scale_x_discrete(breaks = function(x){x[c(TRUE, FALSE)]})
```

```{r}
mimic_creat_b <- aki_creat_analysis %>% 
  filter(MAX_STAGE_NEW_CONS == 2,
         AKI_TO_CREAT >= -24,
         AKI_TO_CREAT <= 48) %>%
  mutate(AKI_TO_CREAT_BIN = cut(AKI_TO_CREAT, 
                                breaks=12, 
                                ordered_result = TRUE,
                                # labels=FALSE
                                )) %>%
ggplot(aes(factor(AKI_TO_CREAT_BIN), CREAT_LOWEST7_DIFF)) +
    geom_boxplot(linetype = "dashed", outlier.shape = NA, color="brown") +
    stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = NA, color="brown", fill="orange") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..), color="brown") +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..), color="brown") +
    stat_summary(fun.y=mean, colour="darkred", geom="point", hape=18, size=2,show_guide = FALSE) +
    # scale_x_discrete(labels=c('-24      ','-18      ','-12      ','-6      ','0      ','6      ','12      ','18      ','24      ','30      ','36      ','42      ','48      ')) +
    labs(x=" ", y = " ") +
    coord_cartesian(ylim = c(-0.1, 3)) +
    theme_classic() + # remove panel background and gridlines
    theme(legend.position = "bottom",
          plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
          plot.subtitle = element_text(size = 10, face = "bold"),
          # axis.text.x = element_text(margin = margin(t = 2),
          #                            hjust="1")
          ) +
  scale_x_discrete(breaks = function(x){x[c(TRUE, FALSE)]})
```

```{r}
mimic_creat_c <- aki_creat_analysis %>% 
  filter(MAX_STAGE_NEW_CONS == 3,
         AKI_TO_CREAT >= -24,
         AKI_TO_CREAT <= 48) %>%
  mutate(AKI_TO_CREAT_BIN = cut(AKI_TO_CREAT, 
                                breaks=12, 
                                ordered_result = TRUE,
                                # labels=FALSE
                                )) %>%
ggplot(aes(factor(AKI_TO_CREAT_BIN), CREAT_LOWEST7_DIFF)) +
    geom_boxplot(linetype = "dashed", outlier.shape = NA, color="brown") +
    stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = NA, color="brown", fill="orange") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..), color="brown") +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..), color="brown") +
    stat_summary(fun.y=mean, colour="darkred", geom="point", hape=18, size=2,show_guide = FALSE) +
    # scale_x_discrete(labels=c('-24      ','-18      ','-12      ','-6      ','0      ','6      ','12      ','18      ','24      ','30      ','36      ','42      ','48      ')) +
    labs(x=" ", y = " ") +
    coord_cartesian(ylim = c(-0.1, 3)) +
    theme_classic() + # remove panel background and gridlines
    theme(legend.position = "bottom",
          plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
          plot.subtitle = element_text(size = 10, face = "bold"),
          # axis.text.x = element_text(margin = margin(t = 2),
          #                            hjust="1")
          ) +
  scale_x_discrete(breaks = function(x){x[c(TRUE, FALSE)]})
```

```{r}
mimic_creat_d <- aki_creat_analysis %>% 
  filter(MAX_STAGE_NEW_CONS == 1,
         AKI_TO_CREAT >= -24,
         AKI_TO_CREAT <= 48) %>%
  mutate(AKI_TO_CREAT_BIN = cut(AKI_TO_CREAT, 
                                breaks=12, 
                                ordered_result = TRUE)) %>%
ggplot(aes(factor(AKI_TO_CREAT_BIN), CREAT_LOWEST7_RATIO)) +
    geom_boxplot(linetype = "dashed", outlier.shape = NA, color="brown") +
    stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = NA, color="brown", fill="orange") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..), color="brown") +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..), color="brown") +
    stat_summary(fun.y=mean, colour="darkred", geom="point", hape=18, size=2,show_guide = FALSE) +
    labs(x=" ", y = "Relative sCr change") +
    coord_cartesian(ylim = c(1.01, 3)) +
    theme_classic() + # remove panel background and gridlines
    theme(legend.position = "bottom",
          plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
          plot.subtitle = element_text(size = 10, face = "bold")) +
  scale_x_discrete(breaks = function(x){x[c(TRUE, FALSE)]})
```

```{r}
mimic_creat_e <- aki_creat_analysis %>% 
  filter(MAX_STAGE_NEW_CONS == 2,
         AKI_TO_CREAT >= -24,
         AKI_TO_CREAT <= 48) %>%
  mutate(AKI_TO_CREAT_BIN = cut(AKI_TO_CREAT, 
                                breaks=12, 
                                ordered_result = TRUE)) %>%
ggplot(aes(factor(AKI_TO_CREAT_BIN), CREAT_LOWEST7_RATIO)) +
    geom_boxplot(linetype = "dashed", outlier.shape = NA, color="brown") +
    stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = NA, color="brown", fill="orange") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..), color="brown") +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..), color="brown") +
    stat_summary(fun.y=mean, colour="darkred", geom="point", hape=18, size=2,show_guide = FALSE) +
    labs(x="Time to AKI start (hours)", y = " ") +
    coord_cartesian(ylim = c(1.01, 3)) +
    theme_classic() + # remove panel background and gridlines
    theme(legend.position = "bottom",
          plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
          plot.subtitle = element_text(size = 10, face = "bold")) +
  scale_x_discrete(breaks = function(x){x[c(TRUE, FALSE)]})
```

```{r}
mimic_creat_f <- aki_creat_analysis %>% 
  filter(MAX_STAGE_NEW_CONS == 3,
         AKI_TO_CREAT >= -24,
         AKI_TO_CREAT <= 48) %>%
  mutate(AKI_TO_CREAT_BIN = cut(AKI_TO_CREAT, 
                                breaks=12, 
                                ordered_result = TRUE)) %>%
ggplot(aes(factor(AKI_TO_CREAT_BIN), CREAT_LOWEST7_RATIO)) +
    geom_boxplot(linetype = "dashed", outlier.shape = NA, color="brown") +
    stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = NA, color="brown", fill="orange") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..), color="brown") +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..), color="brown") +
    stat_summary(fun.y=mean, colour="darkred", geom="point", hape=18, size=2,show_guide = FALSE) +
    labs(x=" ", y = " ") +
    coord_cartesian(ylim = c(1.01, 3)) +
    theme_classic() + # remove panel background and gridlines
    theme(legend.position = "bottom",
          plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
          plot.subtitle = element_text(size = 10, face = "bold")) +
  scale_x_discrete(breaks = function(x){x[c(TRUE, FALSE)]})
```

```{r}
ggarrange(
  mimic_creat_a,
  mimic_creat_b,
  mimic_creat_c,
  mimic_creat_d,
  mimic_creat_e,
  mimic_creat_f,
  labels = c("a", "b", "c", "d", "e", "f"),
  ncol = 3,
  nrow = 2,
  heights = c(1,1),
  legend = "bottom",
  common.legend = TRUE
)
```


## Survival Analysis
```{r}
km_fit <- survfit2(Surv(FOLLOWUP_DAYS, DEATH_FLAG) ~ MAX_STAGE_NEW_CONS, data = akis_all_wide)

mimic_survival_cons_figure <- km_fit %>%
ggsurvfit(linewidth = 1) +
  scale_ggsurvfit(x_scales = list(breaks = seq(0, 30, by = 5))) +
  coord_cartesian(xlim = c(-1, 31)) +
  theme_classic() +
  labs(x="Days", y = "Survival", 
       color='Maximum KDIGO-UO stage', fill='Maximum KDIGO-UO stage') +
  scale_color_jama() +
  scale_fill_jama() +
  theme(legend.position = "bottom",
        plot.title = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold")) +
  add_risktable() +
  add_pvalue(caption = "Log-rank {p.value}")

mimic_survival_cons_figure
```


table of survival probabilities:

```{r}
mimic_survival_table <-
  km_fit %>% tbl_survfit(times = c(7, 30, 90, 365),
                                                 label = "Maximum KDIGO-UO stage",
                                                 label_header = "**Day {time}**")
mimic_survival_table
```

Log rank for each pair:

```{r}
survdiff(Surv(FOLLOWUP_DAYS, mortality_30) ~ MAX_STAGE_NEW_CONS, data = akis_all_wide)

akis_all_wide_non_01 <- akis_all_wide %>%
  filter(MAX_STAGE_NEW_CONS == 0 | MAX_STAGE_NEW_CONS == 1)
survdiff(Surv(FOLLOWUP_DAYS, mortality_30) ~ MAX_STAGE_NEW_CONS, data = akis_all_wide_non_01)

akis_all_wide_non_12 <- akis_all_wide %>%
  filter(MAX_STAGE_NEW_CONS == 1 | MAX_STAGE_NEW_CONS == 2)
survdiff(Surv(FOLLOWUP_DAYS, mortality_30) ~ MAX_STAGE_NEW_CONS, data = akis_all_wide_non_12)

akis_all_wide_non_23 <- akis_all_wide %>%
  filter(MAX_STAGE_NEW_CONS == 2 | MAX_STAGE_NEW_CONS == 3)
survdiff(Surv(FOLLOWUP_DAYS, mortality_30) ~ MAX_STAGE_NEW_CONS, data = akis_all_wide_non_23)
```


```{r}
mimic_t1a <- t1a
mimic_t1b <- t1b
mimic_table_1 <- table_1
mimic_table_1_akis <- table1_akis
mimic_uo_rate <- uo_rate
mimic_aki_epi <- akis_all_long %>%
  filter(group == "newcons")
mimic_akis_all_wide <- akis_all_wide
mimic_table_1_staging <- table_1_staging
mimic_rr_table_data <- rr_table_data
mimic_rr_table_data_adj <- rr_table_data %>% 
  left_join(bind_rows(rr_table_data_m1_adj1, rr_table_data_m2_adj1, rr_table_data_m3_adj1))

save(mimic_t1a,
     mimic_t1b,
     mimic_table_1,
     mimic_table_1_akis,
     mimic_uo_rate,
     mimic_uo_cons_figure,
     mimic_survival_cons_figure,
     mimic_survival_table,
     mimic_aki_epi,
     mimic_akis_all_wide,
     mimic_table_1_staging,
     mimic_rr_table_data,
     mimic_rr_table_data_adj,
     file = "paper_mimic.Rda")
```

```{r}
mimic_uo_rate <- uo_rate
mimic_hourly_uo <- hourly_uo
mimic_raw_uo_eligible <- raw_uo_eligible

save(
  all_rows_count,
  distinct_time_item_patient_rows_count,
  S2_a,
  S3a,
  S4_a,
  S4_b,
  S4_c,
  S4_d,
  S4_e,
  S4_f,
  S6_a,
  S6_b,
  # S7_a,
  # S7_b,
  S7_c,
  S7_d,
  # S8_a,
  # S8_b,
  S8_c,
  S8_d,
  S8_e,
  # S8_f,
  S9_a,
  S9_b,
  S9_c,
  S9_d,
  S11,
  # mimic_uo_rate,
  # mimic_hourly_uo,
  # mimic_raw_uo_eligible,
  mimic_exclusion_threshold,
  mimic_kdigo_inter_aki_table,
  mimic_kdigo_inter_cons_mean,
  mimic_kdigo_inter_cons_old,
  mimic_kdigo_inter_mean_old,
  mimic_kdigo_inter_bic,
  mimic_kdigo_inter_survival_table,
  mimic_kdigo_inter_survival_table_adj,
  mimic_kdigo_inter_survival_figure,
  mimic_Sage_a,
  mimic_Sage_b,
  mimic_Sweight_a,
  mimic_Sweight_b,
  file = "s_data.Rda"
)
```


------------------------------------------------------------------------

# Technical Details

## R Session Info:

```{r}
sessionInfo()
```

::: {.tocify-extend-page data-unique="tocify-extend-page" style="height: 0;"}
:::
